'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _utils = require('utils');

var _Toast = require('../../../components/Toast');

var _Toast2 = _interopRequireDefault(_Toast);

var _DownloadPopup = require('../components/DownloadPopup');

var _DownloadPopup2 = _interopRequireDefault(_DownloadPopup);

require('scss/activity/invite.component.scss');

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var Share = function (_React$Component) {
  (0, _inherits3.default)(Share, _React$Component);

  function Share(props) {
    (0, _classCallCheck3.default)(this, Share);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Share.__proto__ || (0, _getPrototypeOf2.default)(Share)).call(this, props));

    _this.codeFlag = 1;
    _this.state = {
      inviteTel: '',
      popupFlag: false,
      phoneNumber: '',
      password: '',
      code: '',
      codeText: '获取验证码',
      popupState: {
        isShow: false,
        tip: '',
        content: '',
        callback: ''
      }
    };
    return _this;
  }

  (0, _createClass3.default)(Share, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      var _this2 = this;

      document.title = '兼职赚钱';
      (0, _utils.share)('inviteFour');
      document.getElementById('checkbox').checked = true;
      var inviteCode = encodeURIComponent(this.getUrlParam().invite_code);
      _Toast2.default.loading('');
      (0, _utils.get)('http://credit.xianjincard.com/credit-invite/get-user-info?invite_code=' + inviteCode).then(function (data) {
        return data.data;
      }).then(function (data) {
        _Toast2.default.hide();
        if (data.code !== 1) {
          _this2.popupInfo(data.message, '朕知道了');
          return;
        }
        _this2.setState({
          inviteTel: data.data.phone
        });
      });
    }
  }, {
    key: 'getUrlParam',
    value: function getUrlParam() {
      var requestParameters = {};

      var url = window.location.href;
      var urlArr = url.split('?');
      if (urlArr[1]) {
        var urlParameters = urlArr[1].split('#')[0];
        if (urlParameters.indexOf('?') === -1) {
          var parameters = decodeURI(urlParameters);
          var parameterArray = parameters.split('&');
          for (var i = 0; i < parameterArray.length; i++) {
            requestParameters[parameterArray[i].split('=')[0]] = parameterArray[i].split('=')[1];
          }
        }
      }
      return requestParameters;
    }
  }, {
    key: 'popupInfo',
    value: function popupInfo(content, tip, callback) {
      this.setState({
        popupState: {
          isShow: true,
          content: content,
          tip: tip,
          callback: callback
        }
      });
    }
  }, {
    key: 'closePopup',
    value: function closePopup(e) {
      this.setState({ popupState: { isShow: false } });
    }
  }, {
    key: 'okPopup',
    value: function okPopup(e) {
      this.state.popupState.callback && this.state.popupState.callback();
      this.closePopup();
    }
  }, {
    key: 'regProtocol',
    value: function regProtocol() {
      location.href = 'https://api.xianjincard.com/act/protocol';
    }
  }, {
    key: 'handleChange',
    value: function handleChange(e) {
      if (e.target.value.length > 11) {
        return;
      }
      this.setState({
        phoneNumber: e.target.value
      });
    }
  }, {
    key: 'handleChangeTwo',
    value: function handleChangeTwo(e) {
      this.setState({
        password: e.target.value
      });
    }
  }, {
    key: 'handleChangeThree',
    value: function handleChangeThree(e) {
      if (e.target.value.length > 6) {
        return;
      }
      this.setState({
        code: e.target.value
      });
    }
  }, {
    key: 'verifyPhone',
    value: function verifyPhone(phone) {
      var reg = /^1(3|4|5|7|8)\d{9}$/;
      if (phone === '') {
        this.popupInfo('手机号不能为空哦~', '朕知道了');
        return false;
      }
      if (!reg.test(phone)) {
        this.popupInfo('请输入正确的手机号哦~', '朕知道了');
        return false;
      }
      return true;
    }
  }, {
    key: 'verfiy',
    value: function verfiy() {
      var _state = this.state,
          phoneNumber = _state.phoneNumber,
          password = _state.password,
          code = _state.code;

      if (this.verifyPhone(phoneNumber)) {
        if (password === '') {
          this.popupInfo('请设置你的登录密码哦~', '朕知道了');
          return false;
        }
        if (password.length < 6) {
          this.popupInfo('密码不能小于6位哦~', '朕知道了');
          return false;
        }
        if (code === '') {
          this.popupInfo('请输入验证码哦~', '朕知道了');
          return false;
        }
        if (!document.getElementById('checkbox').checked) {
          this.popupInfo('请阅读并同意《现金白卡使用协议》哦~', '朕知道了');
          return false;
        }
      } else {
        return false;
      }
      return true;
    }
  }, {
    key: 'getCode',
    value: function getCode() {
      var _this3 = this;

      var phone = this.state.phoneNumber;
      if (this.verifyPhone(phone) && this.codeFlag) {
        _Toast2.default.loading('');
        (0, _utils.post)('http://api.xianjincard.com/user/reg-get-code', { phone: phone }).then(function (data) {
          return data.data;
        }).then(function (data) {
          _Toast2.default.hide();
          if (data.code === 1000) {
            _this3.popupInfo('你已经注册过了哦~', '马上借款', _utils.goHome);
            _this3.setState({
              popupFlag: true
            });
            return;
          }
          if (data.code === 0) {
            _this3.setCodeText(60);
            return;
          }
          _this3.popupInfo('服务器繁忙 请稍候重试', '朕知道了');
        });
      }
    }
  }, {
    key: 'setCodeText',
    value: function setCodeText(number, l) {
      var _this4 = this;

      setTimeout(function () {
        var codeText = number + '秒后重试';
        _this4.setState({
          codeText: codeText
        });
        if (number) {
          _this4.codeFlag = 0;
          _this4.setCodeText(--number, 1000);
        } else {
          _this4.codeFlag = 1;
          _this4.setState({
            codeText: '重新发送'
          });
        }
      }, l);
    }
  }, {
    key: 'reg',
    value: function reg() {
      var _this5 = this;

      if (this.verfiy()) {
        var _state2 = this.state,
            phoneNumber = _state2.phoneNumber,
            password = _state2.password,
            code = _state2.code;

        var query = this.props.location.query;
        var activityId = query.tag || '';
        _Toast2.default.loading('');
        (0, _utils.post)('http://credit.xianjincard.com/credit-user/register?appMarket=' + activityId, { phone: phoneNumber, password: password, code: code, source: 21, invite_code: encodeURIComponent(this.getUrlParam().invite_code) }).then(function (data) {
          return data.data;
        }).then(function (data) {
          _Toast2.default.hide();
          if (data.code === 0) {
            _this5.popupInfo('恭喜您！<br />成功注册现金白卡', '马上借款', _utils.goHome);
            _this5.setState({
              popupFlag: true
            });
          } else {
            var message = data.message ? data.message : '服务器繁忙，请稍候重试';
            _this5.popupInfo('' + message, '朕知道了');
          }
        });
      }
    }
  }, {
    key: 'makeMoney',
    value: function makeMoney() {
      _utils.redirect.push('/activity/invite');
    }
  }, {
    key: 'render',
    value: function render() {
      var _state3 = this.state,
          popupState = _state3.popupState,
          codeText = _state3.codeText,
          inviteTel = _state3.inviteTel,
          popupFlag = _state3.popupFlag;

      var popup = popupState.isShow ? _react2.default.createElement('div', { className: 'popup popup-share' }, _react2.default.createElement('div', { className: 'overlay', onClick: this.closePopup.bind(this) }), _react2.default.createElement('div', { className: 'dialog' }, _react2.default.createElement('span', { className: 'close', onClick: this.closePopup.bind(this) }), _react2.default.createElement('p', { className: '' + (popupFlag ? '' : 'p-error'), dangerouslySetInnerHTML: { __html: popupState.content } }), _react2.default.createElement('a', { className: 'a-button ' + (popupFlag ? '' : 'a-error'), onClick: this.okPopup.bind(this) }, popupState.tip), popupFlag ? _react2.default.createElement('a', { className: 'make-money', onClick: this.makeMoney.bind(this) }, '\u9080\u8BF7\u53BB\u8D5A\u94B1') : null)) : null;

      return _react2.default.createElement('div', { className: 'transition-group' }, _react2.default.createElement('div', { className: 'share' }, _react2.default.createElement('p', { className: 'yf' }, '\u4F60\u7684\u597D\u53CB', _react2.default.createElement('b', null, inviteTel), _react2.default.createElement('br', null), '\u9001\u4F60\u4E00\u4E2A\u73B0\u91D1\u5927\u793C\u5305'), _react2.default.createElement('p', null, _react2.default.createElement('input', { ref: 'phoneInput', className: 'tel', id: 'phone', type: 'text', value: this.state.phoneNumber, placeholder: '\u8BF7\u8F93\u5165\u624B\u673A\u53F7', onChange: this.handleChange.bind(this) })), _react2.default.createElement('p', null, _react2.default.createElement('input', { className: 'password', id: 'password', type: 'password', value: this.state.password, placeholder: '\u8BF7\u8BBE\u7F6E\u767B\u5F55\u5BC6\u7801', onChange: this.handleChangeTwo.bind(this) })), _react2.default.createElement('p', { className: 'special clearfix' }, _react2.default.createElement('input', { className: 'code', id: 'code', type: 'text', value: this.state.code, placeholder: '\u8BF7\u8F93\u5165\u9A8C\u8BC1\u7801', onChange: this.handleChangeThree.bind(this) }), _react2.default.createElement('a', { onClick: this.getCode.bind(this) }, codeText)), _react2.default.createElement('p', { className: 'clearfix other' }, _react2.default.createElement('input', { id: 'checkbox', type: 'checkbox', value: '', style: { display: 'none' } }), _react2.default.createElement('label', { htmlFor: 'checkbox' }, '\u6211\u5DF2\u9605\u8BFB\u5E76\u540C\u610F', _react2.default.createElement('a', { onClick: this.regProtocol.bind(this) }, '\u300A\u73B0\u91D1\u767D\u5361\u4F7F\u7528\u534F\u8BAE\u300B'), _react2.default.createElement('i', null))), _react2.default.createElement('a', { className: 'reg', onClick: this.reg.bind(this) }, _react2.default.createElement('span', null, '\u9A6C\u4E0A\u9886\u94B1')), _react2.default.createElement('p', { className: 'company' }, '\u6295\u8D44\u6709\u98CE\u9669 \u5165\u5E02\u9700\u8C28\u614E', _react2.default.createElement('br', null), '\u4E0A\u6D77\u6D45\u6A59\u7F51\u7EDC\u79D1\u6280\u6709\u9650\u516C\u53F8', _react2.default.createElement('br', null), '\u6CAAICP\u590716040623\u53F7')), popup, _react2.default.createElement(_DownloadPopup2.default, null));
    }
  }]);
  return Share;
}(_react2.default.Component);

exports.default = Share;
module.exports = exports['default'];