'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _css = require('antd-mobile/lib/refresh-control/style/css');

var _refreshControl = require('antd-mobile/lib/refresh-control');

var _refreshControl2 = _interopRequireDefault(_refreshControl);

var _css2 = require('antd-mobile/lib/icon/style/css');

var _icon = require('antd-mobile/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _css3 = require('antd-mobile/lib/button/style/css');

var _button = require('antd-mobile/lib/button');

var _button2 = _interopRequireDefault(_button);

var _css4 = require('antd-mobile/lib/flex/style/css');

var _flex = require('antd-mobile/lib/flex');

var _flex2 = _interopRequireDefault(_flex);

var _css5 = require('antd-mobile/lib/list-view/style/css');

var _listView = require('antd-mobile/lib/list-view');

var _listView2 = _interopRequireDefault(_listView);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _css6 = require('antd-mobile/lib/list/style/css');

var _list = require('antd-mobile/lib/list');

var _list2 = _interopRequireDefault(_list);

var _css7 = require('antd-mobile/lib/modal/style/css');

var _modal = require('antd-mobile/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactRouter = require('react-router');

var _utils = require('utils');

var _Toast = require('components/Toast');

var _Toast2 = _interopRequireDefault(_Toast);

require('scss/mobile/me.component.scss');

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var alert = _modal2.default.alert;
var Item = _list2.default.Item;
var alter = function alter(px) {
  return px / 2 * window.devicePixelRatio;
};

var Me = function (_React$Component) {
  (0, _inherits3.default)(Me, _React$Component);

  // static contextTypes = {
  //   router: React.PropTypes.object
  // }
  function Me(props) {
    (0, _classCallCheck3.default)(this, Me);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Me.__proto__ || (0, _getPrototypeOf2.default)(Me)).call(this, props));

    _this.al = 0;
    _this.progress = 0;
    var dataSource = new _listView2.default.DataSource({
      rowHasChanged: function rowHasChanged(row1, row2) {
        return row1 !== row2;
      }
    });
    _this.data = {
      item_list: [{ group: 0 }],
      phone: '',
      credit_info: {
        card_amount: 0,
        card_unused_amount: 0
      }
    };
    _this.state = {
      dataSource: dataSource.cloneWithRows([_this.data]),
      refreshing: true
    };
    return _this;
  }

  (0, _createClass3.default)(Me, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      document.title = '个人中心';
      // console.log(this.context)
      // console.log(redirect)
      // this.setState({refreshing: true})

      var canvas = document.querySelector('canvas');
      canvas.width = window.lib.flexible.dpr === 1 ? window.innerWidth * window.devicePixelRatio : window.innerWidth;
      canvas.height = alter(300);
      this.wave(canvas);
    }
  }, {
    key: 'fetchData',
    value: function fetchData() {
      var _this2 = this;

      (0, _utils.get)('http://credit.xianjincard.com/v2/credit-user/get-info').then(function (result) {
        if (result.data.code !== 0) {
          _Toast2.default.info(result.data.message, 2);
          return;
        }
        _this2.data = result.data.data.item;
        _this2.setState({
          dataSource: _this2.state.dataSource.cloneWithRows([_this2.data]),
          refreshing: false
        });
        _this2.onLoad();
      }).catch(function (error) {
        console.log(error);
      });
    }
  }, {
    key: 'onRefresh',
    value: function onRefresh() {
      this.setState({ refreshing: true });
      this.fetchData();
    }
  }, {
    key: 'onLoad',
    value: function onLoad() {
      var _data$credit_info = this.data.credit_info,
          total = _data$credit_info.card_locked_amount,
          unused = _data$credit_info.card_unused_amount;

      this.progress = unused / total * 100;
      this.al = 0;
    }
  }, {
    key: 'wave',
    value: function wave(canvas) {
      var _this3 = this;

      var ctx = canvas.getContext('2d');
      var cw = ctx.canvas.width;
      var ch = ctx.canvas.height;

      var offset = 0;
      var count = alter(40);
      var force = Math.sin(count);
      var ly = ch - alter(20);

      var radius = alter(70);
      var x = cw / 2 - radius * 2;
      var y = ch / 2;

      var start = 4.72;
      var diff = 0;
      var interval = null;

      if (interval !== null) {
        clearInterval(interval);
      }
      interval = setInterval(function () {
        diff = (_this3.al / 100 * Math.PI * 2 * 10).toFixed(2);
        ctx.clearRect(0, 0, cw, ch);

        ctx.lineWidth = alter(25);
        ctx.strokeStyle = '#ddd';
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2, false);
        ctx.stroke();

        ctx.strokeStyle = '#ff8003';
        ctx.beginPath();
        ctx.arc(x, y, radius, start, diff / 10 + start, false);
        ctx.stroke();
        if (_this3.al < _this3.progress) {
          _this3.al += 2;
        }

        force = Math.sin(count);
        count += 0.05;

        ctx.fillStyle = 'rgba(0,0,0,0)';
        ctx.fillRect(0, ly, cw, ch);
        ctx.fillStyle = '#a7ddff';
        ctx.beginPath();
        ctx.moveTo(0, ly);
        ctx.quadraticCurveTo(cw / 4 + offset, ly + force * alter(40), cw / 2 + offset, ly);
        ctx.quadraticCurveTo(cw * 0.75 + offset, ly - force * alter(30), cw + offset, ly);
        ctx.lineTo(cw, ch);
        ctx.lineTo(0, ch);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = 'rgba(0, 0, 0, 0)';
        ctx.fillRect(0, ly, cw, ch);
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.moveTo(0, ly);
        ctx.quadraticCurveTo(cw / 4 + offset, ly - force * alter(30), cw / 2 + offset, ly);
        ctx.quadraticCurveTo(cw * 0.75 + offset, ly + force * alter(20), cw + offset, ly);
        ctx.lineTo(cw, ch);
        ctx.lineTo(0, ch);
        ctx.closePath();
        ctx.fill();

        offset += 3;
        if (offset > alter(200)) {
          offset = 0;
        }
      }, 50);
    }
  }, {
    key: 'onClick',
    value: function onClick(item) {
      if (item.tag === 1) {
        _utils.redirect.push('/mobile/order');
        return;
      }

      if (item.tag === 2) {
        _utils.redirect.push('/mobile/certification');
        return;
      }

      location.href = item.url;
    }
  }, {
    key: 'logout',
    value: function logout() {
      alert('确 定', '你确定退出登录', [{ text: '取 消' }, { text: '确 定', onPress: function onPress() {
          (0, _utils.get)('http://credit.xianjincard.com/credit-user/logout');
          (0, _utils.login)();
        } }]);
    }
  }, {
    key: 'listA',
    value: function listA(items) {
      var _this4 = this;

      return items.map(function (v, i) {
        if (v.group === 1) {
          return _react2.default.createElement(Item, { key: i, thumb: v.logo, extra: v.subtitle, arrow: 'horizontal', onClick: _this4.onClick.bind(_this4, v) }, v.title);
        }
      });
    }
  }, {
    key: 'listB',
    value: function listB(items) {
      var _this5 = this;

      return items.map(function (v, i) {
        if (v.group === 2 && v.url) {
          return _react2.default.createElement(Item, { key: i, thumb: v.logo, extra: v.subtitle, arrow: 'horizontal', onClick: _this5.onClick.bind(_this5, v) }, v.title);
        }
      });
    }
  }, {
    key: 'render',
    value: function render() {
      var _this6 = this;

      var row = function row(rowData, sectionID, rowID) {
        return _react2.default.createElement('div', { className: 'me' }, _react2.default.createElement('div', { className: 'head' }, _react2.default.createElement('ul', { className: 'content' }, _react2.default.createElement('li', null, rowData.phone, ' ', _react2.default.createElement('a', { href: rowData.active_url }, '\u63D0\u989D\u653B\u7565')), _react2.default.createElement('li', null, '\u603B\u989D\u5EA6: ', _react2.default.createElement('i', null, rowData.credit_info.card_amount / 100, '\u5143')), _react2.default.createElement('li', null, '\u5269\u4F59\u53EF\u501F: ', _react2.default.createElement('i', null, rowData.credit_info.card_unused_amount / 100, '\u5143'))), _react2.default.createElement('canvas', null), _react2.default.createElement(_flex2.default, { className: 'tab' }, _react2.default.createElement(_flex2.default.Item, null, _react2.default.createElement('a', { className: 'gold-tab', href: '/signin' }, '\u91D1\u5E01')), _react2.default.createElement(_flex2.default.Item, null, _react2.default.createElement('a', { className: 'coupon-tab', href: '/mobile/coupon' }, '\u4F18\u60E0\u5238')), _react2.default.createElement(_flex2.default.Item, null, _react2.default.createElement('a', { className: 'pack-tab', href: '/cash-bonus' }, '\u73B0\u91D1\u7EA2\u5305')))), _react2.default.createElement(_list2.default, null, _this6.listA(rowData.item_list)), _react2.default.createElement(_list2.default, null, _this6.listB(rowData.item_list)), _react2.default.createElement('div', { className: 'btn' }, _react2.default.createElement(_button2.default, { type: 'button', className: 'am-button', onClick: _this6.logout.bind(_this6) }, '\u9000\u51FA\u767B\u5F55')));
      };
      return _react2.default.createElement(_listView2.default, {
        className: 'xjk-refresh',
        dataSource: this.state.dataSource,
        renderRow: row,
        initialListSize: 5,
        pageSize: 5,
        scrollRenderAheadDistance: 200,
        scrollEventThrottle: 20,
        style: {
          height: document.documentElement.clientHeight
        },
        refreshControl: _react2.default.createElement(_refreshControl2.default, {
          refreshing: this.state.refreshing,
          icon: [_react2.default.createElement('div', { key: '0', className: 'am-refresh-control-pull' }, _react2.default.createElement(_icon2.default, { type: 'arrow-down' }), _react2.default.createElement('span', null, '\u79D1\u6280\u8BA9\u91D1\u878D\u66F4\u7B80\u5355')), _react2.default.createElement('div', { key: '1', className: 'am-refresh-control-release' }, _react2.default.createElement(_icon2.default, { type: 'arrow-up' }), _react2.default.createElement('span', null, '\u79D1\u6280\u8BA9\u91D1\u878D\u66F4\u7B80\u5355'))],
          distanceToRefresh: 40 * window.lib.flexible.dpr,
          onRefresh: this.onRefresh.bind(this) }) });
    }
  }]);
  return Me;
}(_react2.default.Component);

exports.default = Me;
module.exports = exports['default'];