'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _utils = require('utils');

var _Toast = require('../../../components/Toast');

var _Toast2 = _interopRequireDefault(_Toast);

var _Popup = require('../components/Popup');

var _Popup2 = _interopRequireDefault(_Popup);

var _Content = require('./Content');

var _Content2 = _interopRequireDefault(_Content);

require('img/activity/share/share-12.png');

require('scss/activity/share.component.scss');

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var Share = function (_React$Component) {
  (0, _inherits3.default)(Share, _React$Component);

  function Share(props) {
    (0, _classCallCheck3.default)(this, Share);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Share.__proto__ || (0, _getPrototypeOf2.default)(Share)).call(this, props));

    _this.sign = '';
    _this.timeout = '';
    _this.codeFlag = 1;
    _this.state = {
      contentFlag: false,
      inputFlag: false,
      ticketFlag: false,
      phoneNumber: '',
      password: '',
      code: '',
      codeText: '获取验证码',
      invite_code: '',
      infoData: {
        amount: 0,
        expire_date: '',
        tel: ''
      }
    };
    return _this;
  }

  (0, _createClass3.default)(Share, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      var _this2 = this;

      document.title = '分享红包';
      var query = this.props.location.query;
      this.sign = query.sign;
      (0, _utils.share)('share');
      _Toast2.default.loading('');
      (0, _utils.get)('http://credit.xianjincard.com/act/red-pack-act').then(function (data) {
        return data.data;
      }).then(function (data) {
        if (data.code === -1001) {
          _Toast2.default.hide();
          location.href = (0, _utils.resolveUrl)('http://credit.xianjincard.com/wx/user-auth-template?redirectUrl=' + encodeURIComponent(location.href));
          return;
        }
        if (data.code === 0) {
          if (data.data) {
            var params = {
              phone: data.data,
              sign: _this2.sign,
              is_new: 0
            };
            (0, _utils.post)('http://credit.xianjincard.com/act/get-red-pack', params).then(function (data) {
              return data.data;
            }).then(function (data2) {
              _Toast2.default.hide();
              _this2.setInfoData(data2, data.data);
              _this2.setState({
                invite_code: typeof data2.data.invite_code !== 'undefined' ? data2.data.invite_code : ''
              });
            });
            return;
          }
          _Toast2.default.hide();
          _this2.setState({
            contentFlag: true
          });
        } else {
          _Toast2.default.hide();
          var message = data.message ? data.message : '服务器繁忙，请稍候重试';
          _Popup2.default.alert(_Content2.default.popupHtml('' + message), 'popup');
          _Popup2.default.click('a.click');
        }
      });
    }
  }, {
    key: 'receive',
    value: function receive() {
      var _this3 = this;

      if (!this.state.inputFlag) {
        var phoneNumber = this.state.phoneNumber;

        if (this.verifyPhone(phoneNumber)) {
          var params = {
            phone: phoneNumber
          };
          _Toast2.default.loading('');
          (0, _utils.post)('http://credit.xianjincard.com/act/check-user', params).then(function (data) {
            return data.data;
          }).then(function (data) {
            if (data.code === 0) {
              if (data.data.is_new) {
                _Toast2.default.hide();
                _this3.setState({
                  inputFlag: true
                });
                return;
              }
              var paramsTwo = {
                phone: phoneNumber,
                sign: _this3.sign,
                is_new: 0
              };
              (0, _utils.post)('http://credit.xianjincard.com/act/get-red-pack', paramsTwo).then(function (data) {
                return data.data;
              }).then(function (data2) {
                _Toast2.default.hide();
                _this3.setInfoData(data2, phoneNumber);
                _this3.setState({
                  phoneNumber: '',
                  invite_code: typeof data2.data.invite_code !== 'undefined' ? data2.data.invite_code : ''
                });
              });
            } else {
              _Toast2.default.hide();
              var message = data.message ? data.message : '服务器繁忙，请稍候重试';
              _Popup2.default.alert(_Content2.default.popupHtml('' + message), 'popup');
              _Popup2.default.click('a.click');
            }
          });
        }
      } else {
        var _state = this.state,
            _phoneNumber = _state.phoneNumber,
            password = _state.password,
            code = _state.code;

        if (this.verfiy(_phoneNumber, password, code)) {
          _Toast2.default.loading('');
          var activityId = 'ShareRed';
          (0, _utils.post)('http://credit.xianjincard.com/credit-user/register?appMarket=' + activityId, { phone: _phoneNumber, password: password, code: code, source: 21 }).then(function (data) {
            return data.data;
          }).then(function (data) {
            if (data.code === 0) {
              _Toast2.default.hide();
              var _params = {
                phone: _phoneNumber,
                sign: _this3.sign,
                is_new: 1
              };
              (0, _utils.post)('http://credit.xianjincard.com/act/get-red-pack', _params).then(function (data) {
                return data.data;
              }).then(function (data2) {
                _Toast2.default.hide();
                _this3.codeFlag = 1;
                clearTimeout(_this3.timeout);
                _this3.setInfoData(data2, _phoneNumber);
                _this3.setState({
                  codeText: '获取验证码',
                  phoneNumber: '',
                  password: '',
                  code: '',
                  invite_code: typeof data2.data.invite_code !== 'undefined' ? data2.data.invite_code : ''
                });
              });
            } else {
              _Toast2.default.hide();
              var message = data.message ? data.message : '服务器繁忙，请稍候重试';
              _Popup2.default.alert(_Content2.default.popupHtml('' + message), 'popup');
              _Popup2.default.click('a.click');
            }
          });
        }
      }
    }
  }, {
    key: 'setInfoData',
    value: function setInfoData(data2, phone) {
      if (data2.code === -1004 || data2.code === -1002) {
        this.setState({
          contentFlag: true,
          inputFlag: false
        });
        return;
      }
      if (data2.code === -2010) {
        this.setState({
          infoData: {
            amount: data2.data.amount,
            expire_date: data2.data.expire_date,
            tel: phone
          },
          contentFlag: false,
          ticketFlag: true
        });
        _Toast2.default.info('你已领取过该红包哦~', 2);
        return;
      }
      if (data2.code === 0) {
        this.setState({
          infoData: {
            amount: data2.data.amount,
            expire_date: data2.data.expire_date,
            tel: phone
          },
          contentFlag: false,
          ticketFlag: true
        });
        return;
      }
      var ticketHtml = _Content2.default.ticketNodata(data2.code);
      this.setState({
        contentFlag: false,
        ticketFlag: false,
        ticketHtml: ticketHtml
      });
      return;
    }
  }, {
    key: 'handleChange',
    value: function handleChange(e) {
      if (e.target.value.length < 11) {
        this.setState({
          inputFlag: false
        });
      }
      if (e.target.value.length > 11) {
        return;
      }
      this.setState({
        phoneNumber: e.target.value
      });
    }
  }, {
    key: 'handleChangeTwo',
    value: function handleChangeTwo(e) {
      this.setState({
        password: e.target.value
      });
    }
  }, {
    key: 'handleChangeThree',
    value: function handleChangeThree(e) {
      if (e.target.value.length > 6) {
        return;
      }
      this.setState({
        code: e.target.value
      });
    }
  }, {
    key: 'changePhone',
    value: function changePhone() {
      this.setState({
        contentFlag: true,
        inputFlag: false
      });
    }
  }, {
    key: 'verifyPhone',
    value: function verifyPhone(phone) {
      var reg = /^1(3|4|5|7|8)\d{9}$/;
      if (phone === '') {
        _Popup2.default.alert(_Content2.default.popupHtml('手机号不能为空哦~'), 'popup');
        _Popup2.default.click('a.click');
        return false;
      }
      if (!reg.test(phone)) {
        _Popup2.default.alert(_Content2.default.popupHtml('请输入正确的手机号哦~'), 'popup');
        _Popup2.default.click('a.click');
        return false;
      }
      return true;
    }
  }, {
    key: 'verfiy',
    value: function verfiy(phoneNumber, password, code) {
      if (this.verifyPhone(phoneNumber)) {
        if (password === '') {
          _Popup2.default.alert(_Content2.default.popupHtml('请设置你的登录密码哦~'), 'popup');
          _Popup2.default.click('a.click');
          return false;
        }
        if (password.length < 6) {
          _Popup2.default.alert(_Content2.default.popupHtml('密码不能小于6位哦~'), 'popup');
          _Popup2.default.click('a.click');
          return false;
        }
        if (code === '') {
          _Popup2.default.alert(_Content2.default.popupHtml('请输入验证码哦~'), 'popup');
          _Popup2.default.click('a.click');
          return false;
        }
      } else {
        return false;
      }
      return true;
    }
  }, {
    key: 'getCode',
    value: function getCode() {
      var _this4 = this;

      var phone = this.state.phoneNumber;
      if (this.verifyPhone(phone) && this.codeFlag) {
        _Toast2.default.loading('');
        (0, _utils.post)('http://api.xianjincard.com/user/reg-get-code', { phone: phone }).then(function (data) {
          return data.data;
        }).then(function (data) {
          _Toast2.default.hide();
          if (data.code === 0) {
            _this4.setCodeText(60);
            return;
          }
          _Popup2.default.alert(_Content2.default.popupHtml(''), 'popup');
          _Popup2.default.click('a.click');
        });
      }
    }
  }, {
    key: 'setCodeText',
    value: function setCodeText(number, l) {
      var _this5 = this;

      this.timeout = setTimeout(function () {
        var codeText = number + '秒后重试';
        _this5.setState({
          codeText: codeText
        });
        if (number) {
          _this5.codeFlag = 0;
          _this5.setCodeText(--number, 1000);
        } else {
          _this5.codeFlag = 1;
          _this5.setState({
            codeText: '重新发送'
          });
        }
      }, l);
    }
  }, {
    key: 'invite',
    value: function invite() {
      var inviteUrl = location.protocol + '//' + location.host + '/activity/invite?invite_code=' + this.state.invite_code;
      location.href = inviteUrl;
    }
  }, {
    key: 'render',
    value: function render() {
      var _state2 = this.state,
          contentFlag = _state2.contentFlag,
          inputFlag = _state2.inputFlag,
          codeText = _state2.codeText,
          ticketFlag = _state2.ticketFlag,
          ticketHtml = _state2.ticketHtml,
          infoData = _state2.infoData;

      var input = inputFlag ? _react2.default.createElement('div', null, _react2.default.createElement('input', { className: 'password', type: 'password', placeholder: '\u8BBE\u7F6E\u767B\u5F55\u5BC6\u7801', value: this.state.password, onChange: this.handleChangeTwo.bind(this) }), _react2.default.createElement('p', { className: 'special clearfix' }, _react2.default.createElement('input', { className: 'code', type: 'text', placeholder: '\u8F93\u5165\u9A8C\u8BC1\u7801', value: this.state.code, onChange: this.handleChangeThree.bind(this) }), _react2.default.createElement('a', { className: 'a-code', onClick: this.getCode.bind(this) }, codeText))) : null;

      var ticketContent = ticketFlag ? _react2.default.createElement('div', { className: 'ticket clearfix' }, _react2.default.createElement('div', { className: 'left' }, _react2.default.createElement('p', null, _react2.default.createElement('b', null, infoData.amount), '\u5143'), _react2.default.createElement('p', null, '\u5206\u4EAB\u7EA2\u5305\u62B5\u6263\u5238')), _react2.default.createElement('div', { className: 'right' }, _react2.default.createElement('p', null, '\u9650\u501F\u6B3E\u91D1\u989D\uFF1A\u6EE1', _react2.default.createElement('b', null, '1000'), '\u5143'), _react2.default.createElement('p', null, '\u9650\u501F\u6B3E\u671F\u9650: ', _react2.default.createElement('b', null, '14'), '\u5929\u4EE5\u4E0A'), _react2.default.createElement('p', null, '\u6709\u6548\u671F\u81F3: ', infoData.expire_date)), _react2.default.createElement('p', { className: 'account' }, '\u7EA2\u5305\u5DF2\u53D1\u653E\u81F3\u8D26\u6237', _react2.default.createElement('a', { onClick: this.changePhone.bind(this) }, infoData.tel, ' \u4FEE\u6539>'))) : _react2.default.createElement('div', { className: 'ticket no-data', dangerouslySetInnerHTML: { __html: ticketHtml } });

      var content = contentFlag ? _react2.default.createElement('div', { className: 'receive-content' }, _react2.default.createElement('i', { className: 'red' }), _react2.default.createElement('p', null, '\u8BF7\u4E0B\u8F7DAPP\u767B\u5F55\u540E\u65B9\u53EF\u4F7F\u7528\u7EA2\u5305'), _react2.default.createElement('input', { className: 'phone', ref: 'phoneInput', type: 'text', placeholder: '\u8BF7\u8F93\u5165\u624B\u673A\u53F7', value: this.state.phoneNumber, onChange: this.handleChange.bind(this) }), input, _react2.default.createElement('a', { className: 'a-receive', onClick: this.receive.bind(this) }, '\u7ACB\u5373\u9886\u53D6')) : _react2.default.createElement('div', { className: 'ticket-content' }, ticketContent, _react2.default.createElement('a', { className: 'use', onClick: _utils.forwardApp }, '\u7ACB\u5373\u4F7F\u7528'), _react2.default.createElement('a', { className: 'invite', onClick: this.invite.bind(this) }, '\u9080\u8BF7\u597D\u53CB\u9001\u7EA2\u5305\uFF0C\u5956\u52B1\u505C\u4E0D\u4E0B\u6765'));

      return _react2.default.createElement('div', { className: 'transition-group' }, _react2.default.createElement('div', { className: 'share' }, _react2.default.createElement('div', { className: 'content' }, content), _react2.default.createElement('div', { className: 'rule' }, _react2.default.createElement('h3', null, '\u6D3B\u52A8\u7EC6\u5219'), _react2.default.createElement('p', null, '1\u3001\u7EA2\u5305\u65B0\u8001\u7528\u6237\u540C\u4EAB'), _react2.default.createElement('p', null, '2\u3001\u7EA2\u5305\u4E0E\u5E73\u53F0\u5176\u4ED6\u6D3B\u52A8\u4F18\u60E0\u53EF\u540C\u4EAB'), _react2.default.createElement('p', null, '3\u3001\u6BCF\u4EBA\u6BCF\u5929\u53EA\u6709\u4E09\u6B21\u62A2\u7EA2\u5305\u673A\u4F1A'), _react2.default.createElement('p', null, '4\u3001\u9886\u53D6\u7EA2\u5305\u7684\u624B\u673A\u53F7\u5FC5\u987B\u4E0E\u4F7F\u7528\u8D26\u6237\u4F18\u60E0\u5238\u7684\u624B\u673A\u53F7\u4E00\u81F4'), _react2.default.createElement('p', null, '5\u3001\u53D1\u653E\u81F3\u624B\u673A\u53F7\u7684\u7EA2\u5305\u9700\u5728app\u7528\u624B\u673A\u53F7\u6CE8\u518C\uFF0C\u767B\u5F55\u540E\u65B9\u80FD\u4F7F\u7528'), _react2.default.createElement('p', null, '6\u3001\u73B0\u91D1\u5361\u4FDD\u7559\u6CD5\u5F8B\u5141\u8BB8\u8303\u56F4\u5185\u7684\u5BF9\u6D3B\u52A8\u7684\u89E3\u91CA\u6743'))));
    }
  }]);
  return Share;
}(_react2.default.Component);

exports.default = Share;
module.exports = exports['default'];