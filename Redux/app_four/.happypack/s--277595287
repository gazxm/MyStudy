'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = undefined;

var _css = require('antd-mobile/lib/toast/style/css');

var _toast = require('antd-mobile/lib/toast');

var _toast2 = _interopRequireDefault(_toast);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _css2 = require('antd-mobile/lib/modal/style/css');

var _modal = require('antd-mobile/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _css3 = require('antd-mobile/lib/steps/style/css');

var _steps = require('antd-mobile/lib/steps');

var _steps2 = _interopRequireDefault(_steps);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

require('scss/mobile/certification-layout.component.scss');

var _request = require('common/request');

var _request2 = _interopRequireDefault(_request);

var _utils = require('utils');

var _basics = require('./basics');

var _basics2 = _interopRequireDefault(_basics);

function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : { default: obj };
}

/* eslint-disable */
var READY_TEXT = '正在准备数据';
var COMPLETED_TEXT = '保存';

var Step = _steps2.default.Step;

var CertificationLayout = function (_Component) {
    (0, _inherits3.default)(CertificationLayout, _Component);

    function CertificationLayout(props) {
        (0, _classCallCheck3.default)(this, CertificationLayout);

        var _this = (0, _possibleConstructorReturn3.default)(this, (CertificationLayout.__proto__ || (0, _getPrototypeOf2.default)(CertificationLayout)).call(this, props));

        _this.state = {
            steps: [],
            visible: 1,
            current: 0,
            loaded: 0
        };

        _request2.default.interceptors.response.use(function (response) {
            var code = response.code,
                message = response.message;

            if (code == -2) {
                var modal = document.querySelector('.am-modal');
                if (!modal) {
                    _modal2.default.alert('提 示', message, [{
                        text: '确 定',
                        onPress: function onPress() {
                            (0, _utils.login)();
                        }
                    }]);
                }
                return _promise2.default.reject(response);
            } else if ([0, -2].indexOf(code) == -1) {
                return _promise2.default.reject(response);
            }
            return _promise2.default.resolve(response);
        }, function (error) {
            return _promise2.default.reject(error);
        });

        return _this;
    }

    (0, _createClass3.default)(CertificationLayout, [{
        key: 'componentDidMount',
        value: function componentDidMount() {
            this.loadSteps.bind(this)();
        }
    }, {
        key: 'middleware',
        value: function middleware(response) {
            var _this2 = this;

            var code = response.code,
                message = response.message;

            _toast2.default.hide();
            if ([0, -2].indexOf(code) == -1) {
                _toast2.default.fail(message);
            }
            setTimeout(function () {
                _this2.setState({ lock: 1, loaded: 1, loading: 0 });
            });
        }
    }, {
        key: 'step',
        value: function step() {
            var current = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;

            this.setState({
                current: current
            });
        }
    }, {
        key: 'loadSteps',
        value: function loadSteps() {
            var _this3 = this;

            (0, _request2.default)('credit-card/get-verification-step').then(function (response) {
                var _response$data$item = response.data.item,
                    steps = _response$data$item.list,
                    current = _response$data$item.pass_index,
                    pass_verify = _response$data$item.pass_verify,
                    is_show_progress = _response$data$item.is_show_progress;

                steps.map(function (step) {
                    _basics2.default.map(function (basic) {
                        if (step.tag_id == basic.id) {
                            step.name = basic.name;
                            step.link = basic.link;
                        }
                    });
                });
                _this3.setState({
                    steps: steps,
                    current: current - 1,
                    visible: !_utils.platform.isApp && !pass_verify,
                    loaded: 1
                });
            }).catch(this.middleware.bind(this));
        }
    }, {
        key: 'hideSteps',
        value: function hideSteps() {
            this.setState({ visible: 0 });
        }
    }, {
        key: 'loaded',
        value: function loaded() {
            this.setState({
                loaded: 1
            });
        }
    }, {
        key: 'label',
        value: function label(name) {
            if (name && name.length > 1) {
                name = name.split('').map(function (value) {
                    return '<span>' + value + '</span>';
                }).join('');
            }
            return _react2.default.createElement('p', { className: 'label', dangerouslySetInnerHTML: { __html: name } });
        }
    }, {
        key: 'nextStepLink',
        value: function nextStepLink(route) {
            var path = route.path;
            var steps = this.state.steps;

            var url = void 0;
            for (var i = 0; i < steps.length; i++) {
                var _steps$i = steps[i],
                    name = _steps$i.name,
                    link = _steps$i.link;

                var next = steps[i + 1];
                if (name == path && next) {
                    url = next.link;
                    break;
                }
            }
            if (url) {
                this.loadSteps.bind(this)();
                _utils.redirect.replace(url);
            } else {
                _utils.redirect.push('/mobile/loan/1/14/1000');
            }
        }
    }, {
        key: 'getButtonText',
        value: function getButtonText(route) {
            var text = COMPLETED_TEXT;
            // let {path} = route;
            // let {steps} = this.state;

            // for(let i = 0;i < steps.length;i++){
            //     let {name, link, button_text} = steps[i];
            //     if(name == path){
            //         text = button_text;
            //         break;
            //     }
            // }
            return text;
        }
    }, {
        key: 'formatPickerData',
        value: function formatPickerData(data) {
            data.label = data.name || data.bank_name;
            data.value = data.type || data.work_type || data.degrees || data.live_time_type || data.marriage || data.bank_id;
        }
    }, {
        key: 'render',
        value: function render() {
            var _state = this.state,
                steps = _state.steps,
                visible = _state.visible,
                current = _state.current,
                loaded = _state.loaded;

            return _react2.default.createElement('div', { className: (0, _classnames2.default)({ 'wrapper wrapper-mobile wrapper-mobile-certification': true, loaded: loaded }) }, visible && false && _react2.default.createElement(_steps2.default, { className: 'am-steps-certification', current: current, direction: 'horizontal' }, steps.map(function (step, index) {
                return _react2.default.createElement(Step, { key: index, title: step.title, description: step.data || ' ' });
            })), loaded ? _react2.default.cloneElement(this.props.children, {
                READY_TEXT: READY_TEXT,
                COMPLETED_TEXT: COMPLETED_TEXT,
                step: this.step.bind(this),
                loaded: this.loaded.bind(this),
                label: this.label,
                formatPickerData: this.formatPickerData,
                middleware: this.middleware,
                nextStepLink: this.nextStepLink.bind(this),
                hideSteps: this.hideSteps.bind(this),
                getButtonText: this.getButtonText.bind(this)
            }) : '');
        }
    }]);
    return CertificationLayout;
}(_react.Component);

exports.default = CertificationLayout;
;
module.exports = exports['default'];