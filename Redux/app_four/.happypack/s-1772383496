'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = undefined;

var _css = require('antd-mobile/lib/grid/style/css');

var _grid = require('antd-mobile/lib/grid');

var _grid2 = _interopRequireDefault(_grid);

var _css2 = require('antd-mobile/lib/carousel/style/css');

var _carousel = require('antd-mobile/lib/carousel');

var _carousel2 = _interopRequireDefault(_carousel);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _css3 = require('antd-mobile/lib/modal/style/css');

var _modal = require('antd-mobile/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

var _utils = require('utils');

require('scss/mobile/certification.component.scss');

var _request = require('common/request');

var _request2 = _interopRequireDefault(_request);

var _basics = require('./basics');

var _basics2 = _interopRequireDefault(_basics);

var _gauge = require('./gauge');

var _gauge2 = _interopRequireDefault(_gauge);

function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : { default: obj };
}

var title = '认证中心'; /* eslint-disable */

var Certification = function (_Component) {
    (0, _inherits3.default)(Certification, _Component);

    function Certification(props) {
        (0, _classCallCheck3.default)(this, Certification);

        var _this = (0, _possibleConstructorReturn3.default)(this, (Certification.__proto__ || (0, _getPrototypeOf2.default)(Certification)).call(this, props));

        _this.state = {
            loaded: 0
        };

        _request2.default.interceptors.response.use(function (response) {
            var code = response.code,
                message = response.message;

            if (code == -2) {
                _modal2.default.alert('提 示', message, [{
                    text: '确 定',
                    onPress: function onPress() {
                        (0, _utils.login)();
                    }
                }]);
                return _promise2.default.reject(response);
            }
            return _promise2.default.resolve(response);
        }, function (error) {
            return _promise2.default.reject(error);
        });
        return _this;
    }

    (0, _createClass3.default)(Certification, [{
        key: 'componentDidMount',
        value: function componentDidMount() {
            var _this2 = this;

            document.title = title;
            (0, _request2.default)('v2/credit-card/get-verification-info').then(function (response) {
                var _response$data = response.data,
                    _response$data$item = _response$data.item,
                    header = _response$data$item.header,
                    list = _response$data$item.list,
                    list_name = _response$data$item.list_name,
                    is_basics_verify = _response$data.verify_loan_pass,
                    double_repayment = _response$data.double_repayment,
                    is_new_user = _response$data.is_new_user,
                    is_living = _response$data.is_living;

                var verify = [];
                // url format
                list && list.map(function (data) {
                    !data.url && data.first_url && (data.url = data.first_url);
                    data.type == 1 && verify.push(data.tag);
                    _basics2.default.map(function (basic) {
                        if (basic.id == data.tag) {
                            data.url = basic.link;
                        }
                    });
                    if (data.tag == 4 && data.status && is_basics_verify) {
                        data.url = data.first_url;
                    }
                });
                if (!!!is_basics_verify) {
                    for (var i in list) {
                        var _list$i = list[i],
                            id = _list$i.tag,
                            link = _list$i.url,
                            status = _list$i.status;

                        if (verify.indexOf(id) >= 0 && !!!status && link) {
                            _utils.redirect.replace(link);
                            break;
                        }
                    }
                } else {
                    var verifys = [];

                    var _loop = function _loop(_i) {
                        var data = list_name[_i];
                        var children = [];
                        list && list.map(function (data) {
                            _i == data.type && children.push(data);
                        });
                        verifys.push({
                            id: +_i,
                            label: data.title,
                            children: children
                        });
                    };

                    for (var _i in list_name) {
                        _loop(_i);
                    }
                    _this2.setState({
                        header: header,
                        verifys: verifys,
                        is_basics_verify: is_basics_verify,
                        double_repayment: double_repayment,
                        is_new_user: is_new_user,
                        is_living: is_living,
                        loaded: 1
                    });
                    setTimeout(function () {
                        var data = header.verify_score;

                        var gauge = new _gauge2.default({
                            element: _this2.refs.credit,
                            value: 0,
                            value_max: data.max
                        });
                        gauge.render();
                        setTimeout(function () {
                            gauge.update(data.score);
                        }, 500);
                    });
                }
            }).catch(function (response) {
                return response;
            });
        }
    }, {
        key: 'render',
        value: function render() {
            var _refs$wrapper = this.refs.wrapper,
                wrapper = _refs$wrapper === undefined ? { clientWidth: 0 } : _refs$wrapper;
            var _state = this.state,
                _state$header = _state.header,
                header = _state$header === undefined ? {} : _state$header,
                _state$verifys = _state.verifys,
                verifys = _state$verifys === undefined ? [] : _state$verifys,
                loaded = _state.loaded,
                double_repayment = _state.double_repayment,
                is_new_user = _state.is_new_user,
                is_living = _state.is_living;

            var item = function item(data, index) {
                var text = data.title,
                    value = data.data,
                    icon = data.logo,
                    link = data.url,
                    status = data.status,
                    type = data.type;

                var style = {
                    height: wrapper.clientWidth / 4
                };
                var click = function click() {
                    if (!!!link) return;
                    if (!is_new_user && type != 1 && status != 1 && !is_living) {
                        _modal2.default.alert('下载App', '下载app后可完善高级认证，完善后可借更高的额度', [{
                            text: '取消'
                        }, {
                            text: '下载app',
                            onPress: function onPress() {
                                (0, _utils.forwardApp)();
                            }
                        }]);
                        return;
                    }
                    if (/^(https?|\/\/)/.test(link)) {
                        window.location.href = link;
                    } else {
                        _utils.redirect.push(link);
                    }
                };
                return _react2.default.createElement('div', { className: (0, _classnames2.default)({
                        'am-grid-item-contain': true,
                        active: !!status
                    }), style: style, onClick: click }, _react2.default.createElement('div', { className: 'am-grid-icon', style: { backgroundImage: 'url(' + icon + ')' } }), _react2.default.createElement('div', { className: 'am-grid-text' }, text), !status && value && _react2.default.createElement('div', { className: 'corner-mark' }, _react2.default.createElement('span', null, value)));
            };
            return _react2.default.createElement('div', { ref: 'wrapper', className: (0, _classnames2.default)({ 'wrapper wrapper-mobile': true, loaded: loaded }) }, _react2.default.createElement('div', { className: 'authentication' }, _react2.default.createElement('div', { className: 'header' }, _react2.default.createElement('div', { className: 'instruction', onClick: function onClick() {
                    _utils.redirect.push('/mobile/certification/instruction');
                } }, '\u5206\u6570\u8BF4\u660E'), _react2.default.createElement(_carousel2.default, null, _react2.default.createElement('div', { className: 'credit' }, _react2.default.createElement('canvas', { ref: 'credit', 'data-value': '60', 'data-max-value': '120' }), _react2.default.createElement('div', { className: 'tips' }, header.verify_score && header.verify_score.title)), _react2.default.createElement('div', { className: 'credit-amount' }, _react2.default.createElement('div', { className: 'credit-line' }, _react2.default.createElement('div', null, _react2.default.createElement('p', null, header.status == 3 ? header.data : '认证中'), _react2.default.createElement('span', null, '\u6211\u7684\u989D\u5EA6'))), _react2.default.createElement('div', { className: 'tips' }, header.title)))), verifys && verifys.map(function (verify, index) {
                return _react2.default.createElement('div', { key: index }, !(is_new_user && verify.id != 1) ? _react2.default.createElement('div', { className: 'verifys' }, _react2.default.createElement('div', { className: 'title', dangerouslySetInnerHTML: { __html: verify.label } }), verify.children && _react2.default.createElement(_grid2.default, { data: verify.children, renderItem: item })) : '');
            })));
        }
    }]);
    return Certification;
}(_react.Component);

exports.default = Certification;
;
module.exports = exports['default'];