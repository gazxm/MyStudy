'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _Scroll = require('./Scroll');

var _Scroll2 = _interopRequireDefault(_Scroll);

var _Rotate = require('./Rotate');

var _Rotate2 = _interopRequireDefault(_Rotate);

var _Content = require('./Content');

var _Content2 = _interopRequireDefault(_Content);

var _Popup = require('../components/Popup');

var _Popup2 = _interopRequireDefault(_Popup);

var _Toast = require('../../../components/Toast');

var _Toast2 = _interopRequireDefault(_Toast);

var _utils = require('utils');

require('scss/activity/turntable.component.scss');

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var appMarket = 'Turntable';
var goldConsume = 100;

var Turntable = function (_React$Component) {
  (0, _inherits3.default)(Turntable, _React$Component);

  function Turntable(props) {
    (0, _classCallCheck3.default)(this, Turntable);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Turntable.__proto__ || (0, _getPrototypeOf2.default)(Turntable)).call(this, props));

    _this.state = {
      lotteryNumber: 0,
      locked: 1,
      isError: 0,
      isLogin: 0,
      code: 0,
      inviteCode: '',
      gold: 0,
      arr: []
    };
    return _this;
  }

  (0, _createClass3.default)(Turntable, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      var _this2 = this;

      document.title = '现金卡大转盘';
      (0, _utils.share)('Turntable');
      _Toast2.default.loading('');
      (0, _utils.get)('http://credit.xianjincard.com/activity/turntable-act/index').then(function (data) {
        return data.data;
      }).then(function (data) {
        _Toast2.default.hide();
        if (data.code !== 0 && data.code !== -1001) {
          _this2.setState({
            isError: 1,
            code: data.code
          });
          if (data.code === -2013) {
            _this2.setState({
              arr: data.data.list
            });
          }
          if (data.data.invite_code) {
            _this2.setState({
              inviteCode: data.data.invite_code
            });
          }
          _Popup2.default.alert(_Content2.default.errorHtml(data.code), 'popup popup-error');
          return;
        }
        if (data.code === -1001) {
          _this2.setState({
            isLogin: 0
          });
          return;
        }
        if (data.data.gold === null) {
          data.data.gold = 0;
        }
        _this2.setState({
          isLogin: 1,
          lotteryNumber: data.data.times,
          inviteCode: data.data.invite_code,
          gold: data.data.gold,
          arr: data.data.list
        });
      });
    }
  }, {
    key: 'userLogin',
    value: function userLogin(content) {
      var _state = this.state,
          isError = _state.isError,
          code = _state.code;

      var query = this.props.location.query;
      var inviteCode = query.invite_code && query.invite_code !== 'undefined' ? query.invite_code : '';
      if (isError) {
        _Popup2.default.alert(_Content2.default.errorHtml(code), 'popup popup-error');
        return;
      }
      _Popup2.default.alert(_Content2.default.loginHtml(content), 'popup');
      if (query.source_tag) {
        _Popup2.default.click('a.login', function () {
          (0, _utils.login)(query.source_tag, inviteCode);
        });
        return;
      }
      _Popup2.default.click('a.login', function () {
        (0, _utils.login)(appMarket, inviteCode);
      });
    }
  }, {
    key: 'reward',
    value: function reward() {
      var _state2 = this.state,
          isLogin = _state2.isLogin,
          arr = _state2.arr,
          locked = _state2.locked,
          code = _state2.code;

      if (!isLogin && code !== -2013) {
        this.userLogin();
        return;
      }
      if (!locked) {
        _Toast2.default.info('亲，请等待抽奖完再查看奖励哦！', 2);
        return;
      }
      if (!arr.length) {
        _Popup2.default.alert(_Content2.default.rewardHtml(), 'popup');
        return;
      }
      var reward = arr.map(function (v, i) {
        return '<li key={' + i + '}>' + v.time + ' <b>' + v.title + '</b></li>';
      }).join('');
      _Popup2.default.alert(_Content2.default.rewardHtml(reward), 'popup');
    }
  }, {
    key: 'exchange',
    value: function exchange() {
      var _this3 = this;

      var _state3 = this.state,
          isLogin = _state3.isLogin,
          locked = _state3.locked,
          gold = _state3.gold;
      var lotteryNumber = this.state.lotteryNumber;

      if (!isLogin) {
        this.userLogin('3');
        return;
      }
      if (!locked) {
        _Toast2.default.info('亲，请等待抽奖完再兑换哦！', 2);
        return;
      }
      if (gold >= goldConsume) {
        _Popup2.default.alert(_Content2.default.goldHtml(gold, goldConsume), 'popup');
        _Popup2.default.click('a.click', function () {
          (0, _utils.get)('http://credit.xianjincard.com//activity/turntable-act/exchange-times').then(function (data) {
            return data.data;
          }).then(function (data) {
            if (data.code !== 0 && data.code !== -2031) {
              setTimeout(function () {
                _Popup2.default.alert(_Content2.default.errorHtml(data.code), 'popup popup-error');
              }, 350);
              return;
            }
            if (data.code === -2031) {
              setTimeout(function () {
                _Popup2.default.alert(_Content2.default.errorHtml(-2031, gold), 'popup');
                _Popup2.default.click('a.click', function () {
                  _utils.redirect.push('/signin');
                });
              }, 350);
              return;
            }
            _this3.setState({
              lotteryNumber: ++lotteryNumber,
              gold: gold - goldConsume
            });
            _Toast2.default.info('兑换成功', 2);
          });
        });
        return;
      }
      _Popup2.default.alert(_Content2.default.errorHtml(-2031, gold), 'popup');
      _Popup2.default.click('a.click', function () {
        _utils.redirect.push('/signin');
      });
    }
  }, {
    key: 'render',
    value: function render() {
      var lotteryNumber = this.state.lotteryNumber;

      return _react2.default.createElement('div', { className: 'transition-group' }, _react2.default.createElement('div', { className: 'turntable' }, _react2.default.createElement('div', { className: 'head' }), _react2.default.createElement('div', { className: 'content' }, _react2.default.createElement(_Scroll2.default, null), _react2.default.createElement(_Rotate2.default, { Turn: this }), _react2.default.createElement('p', { className: 'chance' }, '\u60A8\u8FD8\u6709', _react2.default.createElement('b', null, lotteryNumber), '\u6B21\u8F6C\u76D8\u673A\u4F1A'), _react2.default.createElement('a', { className: 'reward' }, _react2.default.createElement('span', { onClick: this.reward.bind(this) }, '\u67E5\u770B\u6211\u7684\u5956\u54C1')), _react2.default.createElement('a', { className: 'gold-chance', onClick: this.exchange.bind(this) }, '\u91D1\u5E01\u5151\u6362\u8F6C\u76D8\u673A\u4F1A'), _react2.default.createElement('i', { className: 'wave' }), _react2.default.createElement('div', { className: 'rule' }, _react2.default.createElement('h3', null, '\u6D3B\u52A8\u89C4\u5219'), _react2.default.createElement('p', null, _react2.default.createElement('b', null, '1'), '\u6D3B\u52A8\u65F6\u95F4\uFF1A2017.03.28\u8D77\uFF1B'), _react2.default.createElement('p', null, _react2.default.createElement('b', null, '2'), '\u53C2\u4E0E\u5BF9\u8C61\uFF1A\u5E73\u53F0\u6CE8\u518C\u4F1A\u5458\uFF1B'), _react2.default.createElement('p', null, _react2.default.createElement('b', null, '3'), '\u5982\u4F55\u83B7\u5F97\u8F6C\u76D8\u673A\u4F1A\uFF1A', _react2.default.createElement('br', null), _react2.default.createElement('span', null, '\u6D3B\u52A8\u671F\u95F4\u9996\u6B21\u767B\u9646\u53EF\u83B7\u53D6\u62BD\u5956\u673A\u4F1A1\u6B21\uFF1B', _react2.default.createElement('br', null), '\u9080\u8BF7\u597D\u53CB\u6CE8\u518C\u6210\u529F\u5373\u53EF\u83B7\u53D6\u62BD\u5956\u673A\u4F1A\uFF08\u9080\u8BF71\u4EBA\u6CE8\u518C\u6210\u529F\u83B7\u53D61\u6B21\u62BD\u5956\u673A\u4F1A\uFF09\uFF1B', _react2.default.createElement('br', null), '\u7533\u8BF7\u501F\u6B3E\u53EF\u83B7\u5F97\u62BD\u5956\u673A\u4F1A1\u6B21\uFF1B', _react2.default.createElement('br', null), '\u6D88\u8017', goldConsume, '\u4E2A\u91D1\u5E01\u6765\u5151\u6362\u4E00\u6B21\u62BD\u5956\u673A\u4F1A\uFF1B', _react2.default.createElement('br', null), '\u62BD\u5956\u673A\u4F1A\u53EF\u4EE5\u7D2F\u8BA1\uFF0C\u4E0D\u6E05\u96F6\uFF0C\u6BCF\u5929\u62BD\u5956\u6B21\u6570\u4E0A\u965010\u6B21\u3002')), _react2.default.createElement('p', null, _react2.default.createElement('b', null, '4'), '\u5982\u4F55\u9886\u53D6\u5956\u54C1\uFF1A', _react2.default.createElement('br', null), _react2.default.createElement('span', null, '\u5238\u5956\u52B1\u4E8E\u83B7\u5956\u540E24\u5C0F\u65F6\u5185\u53D1\u653E\uFF0C\u8BF7\u81F3\u201C\u6211\u7684\u201D-\u201C\u6211\u7684\u4F18\u60E0\u201D\u4E2D\u67E5\u770B\u9886\u53D6\uFF0C\u6240\u6709\u5238\u6709\u6548\u671F20\u5929\u3002', _react2.default.createElement('br', null), '\u83B7\u5F97\u5B9E\u7269\u5956\u7684\u7528\u6237\u5C06\u6536\u5230\u5E73\u53F0\u77ED\u4FE1\uFF0C\u7528\u6237\u9700\u5728\u77ED\u4FE1\u89C4\u5B9A\u65F6\u95F4\u5185\u8054\u7CFB\u5BA2\u670D\u9A8C\u8BC1\u4FE1\u606F\uFF0C\u786E\u8BA4\u53D1\u653E\u65B9\u5F0F\u3002')), _react2.default.createElement('p', null, _react2.default.createElement('b', null, '5'), '\u5238\u4E0D\u53EF\u7D2F\u52A0\u4F7F\u7528\uFF0C\u4E0E\u5E73\u53F0\u5176\u4ED6\u6D3B\u52A8\u4F18\u60E0\u4E0D\u80FD\u540C\u4EAB\uFF1B'), _react2.default.createElement('p', null, _react2.default.createElement('b', null, '6'), '\u73B0\u91D1\u5361\u5BA2\u670D\u70ED\u7EBF\uFF1A', _react2.default.createElement('span', { className: 'tel' }, '4006812016'), '\uFF1B'), _react2.default.createElement('p', null, _react2.default.createElement('b', null, '7'), '\u672C\u6D3B\u52A8\u6700\u7EC8\u89E3\u91CA\u6743\u5F52\u73B0\u91D1\u5361\u5E73\u53F0\u6240\u6709\uFF0C\u4E0EApple.Inc\u65E0\u5173')))));
    }
  }]);
  return Turntable;
}(_react2.default.Component);

exports.default = Turntable;
module.exports = exports['default'];