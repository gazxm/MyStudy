'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _css = require('antd-mobile/lib/button/style/css');

var _button = require('antd-mobile/lib/button');

var _button2 = _interopRequireDefault(_button);

var _css2 = require('antd-mobile/lib/picker/style/css');

var _picker = require('antd-mobile/lib/picker');

var _picker2 = _interopRequireDefault(_picker);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _css3 = require('antd-mobile/lib/input-item/style/css');

var _inputItem = require('antd-mobile/lib/input-item');

var _inputItem2 = _interopRequireDefault(_inputItem);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _css4 = require('antd-mobile/lib/toast/style/css');

var _toast = require('antd-mobile/lib/toast');

var _toast2 = _interopRequireDefault(_toast);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _css5 = require('antd-mobile/lib/modal/style/css');

var _modal = require('antd-mobile/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _css6 = require('antd-mobile/lib/list/style/css');

var _list = require('antd-mobile/lib/list');

var _list2 = _interopRequireDefault(_list);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _rcForm = require('rc-form');

var _Timer = require('components/Timer');

var _Timer2 = _interopRequireDefault(_Timer);

var _utils = require('utils');

require('scss/mobile/credit-tied.component.scss');

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var Item = _list2.default.Item;
var alert = _modal2.default.alert;

var TiedCard = function (_React$Component) {
  (0, _inherits3.default)(TiedCard, _React$Component);

  function TiedCard(props) {
    (0, _classCallCheck3.default)(this, TiedCard);

    var _this = (0, _possibleConstructorReturn3.default)(this, (TiedCard.__proto__ || (0, _getPrototypeOf2.default)(TiedCard)).call(this, props));

    document.title = '认证信用卡';
    _this.state = {
      disabled: true,
      phone: false,
      data: {
        name: '',
        list: []
      }
    };
    return _this;
  }

  (0, _createClass3.default)(TiedCard, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      this.fetchData();
    }
  }, {
    key: 'fetchData',
    value: function fetchData() {
      var _this2 = this;

      _toast2.default.loading('加载中...', 0);
      (0, _utils.post)('https://credit.xianjincard.com/credit-card/get-credit-card-list').then(function (response) {
        _toast2.default.hide();
        var _response$data = response.data,
            code = _response$data.code,
            message = _response$data.message,
            data = _response$data.data;

        if (code !== 0) {
          _toast2.default.info(message, 2);
          return;
        }
        // 已绑定过信用卡
        if (data.item && data.item.length > 0) {
          _utils.redirect.push('/mobile/certification/credit/verify');
          return;
        }
        _this2.setState({ data: data });
      }).catch(function (response) {
        _toast2.default.hide();
      });
    }
  }, {
    key: 'sendCode',
    value: function sendCode() {
      (0, _utils.post)('https://credit.xianjincard.com/credit-card/get-code', { phone: this.state.phone }).then(function (response) {
        // console.log(response)
        if (response.data.code !== 0) {
          _toast2.default.info(response.data.message, 2);
        }
      }).catch(function (response) {
        return response;
      });
    }
  }, {
    key: 'submit',
    value: function submit() {
      this.props.form.validateFields(function (error, value) {
        if (!error) {
          value.bank_id = value.bank_id[0];
          value.phone = value.phone.replace(/\s/g, '');
          value.card_no = value.card_no.replace(/\s/g, '');
          _toast2.default.loading(undefined, 0);
          (0, _utils.post)('https://credit.xianjincard.com/credit-card/add-credit-card', value).then(function (response) {
            var _response$data2 = response.data,
                code = _response$data2.code,
                message = _response$data2.message;

            if (code !== 0) {
              _toast2.default.info(message, 3);
              return;
            }
            _toast2.default.success(message, function () {
              _utils.redirect.push('/mobile/certification/credit/verify');
            });
          });
        }
      });
    }
  }, {
    key: 'onChange',
    value: function onChange(val) {
      var _this3 = this;

      this.props.form.validateFields(function (error, value) {
        _this3.setState({ disabled: error });

        if (error) {
          var keys = (0, _keys2.default)(error);
          if (keys.length === 1 && keys[0] === 'bank_id' && Array.isArray(val)) {
            _this3.setState({ disabled: false });
          }
        }
      });

      if (!val) {
        this.setState({ disabled: !val });
      }
    }
  }, {
    key: 'onChangePhone',
    value: function onChangePhone(val) {
      this.setState({ phone: /^1[34578]\d{9}$/.test(val) && val });
    }
  }, {
    key: 'render',
    value: function render() {
      var getFieldProps = this.props.form.getFieldProps;
      var _state$data = this.state.data,
          name = _state$data.name,
          list = _state$data.list;

      return _react2.default.createElement('div', { className: 'transition-group credit-tied-card' }, _react2.default.createElement(_list2.default, { className: 'custom-list' }, _react2.default.createElement(_inputItem2.default, { value: name, editable: false }, '\u59D3\u540D'), _react2.default.createElement(_picker2.default, (0, _extends3.default)({ extra: '\u8BF7\u9009\u62E9\u94F6\u884C', cols: 1, data: list }, getFieldProps('bank_id', { onChange: this.onChange.bind(this), rules: [{ required: true, message: '请选择银行' }] }), { title: '\u8BF7\u9009\u62E9\u94F6\u884C' }), _react2.default.createElement(Item, { arrow: 'horizontal' }, ' \u8BF7\u9009\u62E9\u94F6\u884C ')), _react2.default.createElement(_inputItem2.default, (0, _extends3.default)({ placeholder: '\u8BF7\u8F93\u5165\u4FE1\u7528\u5361\u5361\u53F7', type: 'tel' }, getFieldProps('card_no', { onChange: this.onChange.bind(this), rules: [{ required: true, message: '请输入信用卡卡号' }] })), '\u94F6\u884C\u5361\u53F7'), _react2.default.createElement(_inputItem2.default, (0, _extends3.default)({ placeholder: '\u8BF7\u8F93\u5165\u94F6\u884C\u9884\u7559\u624B\u673A\u53F7', maxLength: 11, type: 'tel' }, getFieldProps('phone', { onChange: this.onChangePhone.bind(this), rules: [{ required: true, pattern: /^1[34578]\d{9}$/, message: '请输入正确手机号' }] })), '\u624B\u673A\u53F7'), _react2.default.createElement(_inputItem2.default, (0, _extends3.default)({ placeholder: '\u8BF7\u8F93\u5165\u9A8C\u8BC1\u7801', type: 'tel' }, getFieldProps('code', { validateFirst: true, onChange: this.onChange.bind(this), rules: [{ required: true, message: '请输入验证码' }] })), '\u9A8C\u8BC1\u7801 ', _react2.default.createElement(_Timer2.default, { disabled: !this.state.phone, className: 'timer', onSend: this.sendCode.bind(this) }))), _react2.default.createElement('div', { className: 'custom-button' }, _react2.default.createElement(_button2.default, { className: 'btn', disabled: this.state.disabled, type: 'primary', onClick: this.submit.bind(this) }, '\u786E\u8BA4\u7ED1\u5361')), _react2.default.createElement('div', { className: 'security-info' }, '\u94F6\u884C\u7EA7\u6570\u636E\u52A0\u5BC6\u4FDD\u62A4'));
    }
  }]);
  return TiedCard;
}(_react2.default.Component);

exports.default = (0, _rcForm.createForm)()(TiedCard);
module.exports = exports['default'];