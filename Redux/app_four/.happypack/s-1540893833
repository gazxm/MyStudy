'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _css = require('antd-mobile/lib/refresh-control/style/css');

var _refreshControl = require('antd-mobile/lib/refresh-control');

var _refreshControl2 = _interopRequireDefault(_refreshControl);

var _css2 = require('antd-mobile/lib/icon/style/css');

var _icon = require('antd-mobile/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _css3 = require('antd-mobile/lib/list-view/style/css');

var _listView = require('antd-mobile/lib/list-view');

var _listView2 = _interopRequireDefault(_listView);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactRouter = require('react-router');

var _utils = require('utils');

var _Toast = require('components/Toast');

var _Toast2 = _interopRequireDefault(_Toast);

require('scss/mobile/coupon.component.scss');

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

// function testable (param) {
//   return function (clazz) {
//     clazz.defaultProps = Object.assign({}, clazz.defaultProps || {}, param)
//     return clazz
//   }
// }

// is_check_loan 1, 2, 3
var message = ['未完成基础认证', '你有处于审核状态下的借款，无法申请新的借款', '你有未还款的借款，请先还完才能继续申请借款'];

var Coupon = function (_React$Component) {
  (0, _inherits3.default)(Coupon, _React$Component);

  function Coupon(props) {
    (0, _classCallCheck3.default)(this, Coupon);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Coupon.__proto__ || (0, _getPrototypeOf2.default)(Coupon)).call(this, props));

    var dataSource = new _listView2.default.DataSource({
      rowHasChanged: function rowHasChanged(row1, row2) {
        return row1 !== row2;
      }
    });
    //    console.log(this.props)
    _this.isNotData = false;
    _this.state = {
      dataSource: dataSource.cloneWithRows([]),
      refreshing: true
    };
    return _this;
  }

  (0, _createClass3.default)(Coupon, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      document.title = '现金券';
      // this.setState({refreshing: true})
    }
  }, {
    key: 'fetchData',
    value: function fetchData() {
      var _this2 = this;

      (0, _utils.get)('http://credit.xianjincard.com/v2/coupon/get-my-coupon').then(function (result) {
        if (result.data.code !== 0) {
          _Toast2.default.info(result.data.message, 2);
          return;
        }
        return result.data.data;
      }).then(function (data) {
        var item = data.item.length > 0 ? data.item : [{ isNotData: true }];
        _this2.setState({
          dataSource: _this2.state.dataSource.cloneWithRows(item),
          refreshing: false
        });
      }).catch(function (error) {
        console.log(error);
      });
    }
  }, {
    key: 'onRefresh',
    value: function onRefresh() {
      this.setState({ refreshing: true });
      this.fetchData();
    }
  }, {
    key: 'onClick',
    value: function onClick(rowData) {
      if (parseInt(rowData.status) === 2) {
        return;
      }
      if (parseInt(rowData.use_type) === 3) {
        if (rowData.is_check_loan > 5) {
          _Toast2.default.info(message[rowData.is_check_loan - 1], 2);
          return;
        }
        _utils.redirect.push('/mobile/loan/' + 1 + '/' + rowData.up_term + '/' + rowData.up_amount + '/' + rowData.coupon_id);
      }
    }
  }, {
    key: 'createFooter',
    value: function createFooter() {
      return _react2.default.createElement(_reactRouter.Link, { to: '/misc/instruction/coupon' }, '\u4F7F\u7528\u8BF4\u660E');
    }
  }, {
    key: 'createEmpty',
    value: function createEmpty() {
      if (this.state.isNotData) {
        return _react2.default.createElement('div', { className: 'result' }, _react2.default.createElement('img', { src: '/assets/img/mobile/misc/icon-1.png' }), _react2.default.createElement('p', null, '\u4F60\u6CA1\u6709\u4EFB\u4F55\u62B5\u6263\u5238\u8BB0\u5F55\u54E6~'), this.createFooter());
      }
    }
  }, {
    key: 'render',
    value: function render() {
      var _this3 = this;

      // status 2 已过期 1 已使用
      var row = function row(rowData, sectionID, rowID) {
        if (rowData.isNotData) {
          return _react2.default.createElement('div', { className: 'result' }, _react2.default.createElement('img', { src: '/assets/img/mobile/misc/icon-1.png' }), _react2.default.createElement('p', null, '\u4F60\u6CA1\u6709\u4EFB\u4F55\u62B5\u6263\u5238\u8BB0\u5F55\u54E6~'));
        }
        var title = parseInt(rowData.use_type) === 2 ? _react2.default.createElement('h3', null, rowData.title) : _react2.default.createElement('h4', null, _react2.default.createElement('i', null, '\uFFE5'), rowData.amount);
        var itemClass = (0, _classnames2.default)({ 'coupon-item': true, 'expired': parseInt(rowData.status) === 2, 'used': parseInt(rowData.status) === 1 });
        return _react2.default.createElement('div', { className: itemClass, key: rowID, onClick: _this3.onClick.bind(_this3, rowData) }, _react2.default.createElement('span', null, title), _react2.default.createElement('span', { className: 'active' }, _react2.default.createElement('div', null, _react2.default.createElement('h3', null, rowData.coupon_name), _react2.default.createElement('p', null, rowData.loan_amount), _react2.default.createElement('p', null, rowData.loan_term), _react2.default.createElement('p', null, rowData.time), _react2.default.createElement('div', null, parseInt(rowData.status) !== 2 && parseInt(rowData.use_type) === 3 && _react2.default.createElement('i', null, '\u70B9\u51FB\u4F7F\u7528')))));
      };

      return _react2.default.createElement('div', { className: 'coupon xjk-refresh' }, _react2.default.createElement(_listView2.default, {
        dataSource: this.state.dataSource,
        renderRow: row,
        initialListSize: 5,
        pageSize: 5,
        scrollRenderAheadDistance: 200,
        scrollEventThrottle: 20,
        style: {
          height: document.documentElement.clientHeight,
          margin: '0.1rem 0'
        },
        scrollerOptions: { scrollbars: true },
        renderFooter: this.createFooter,
        refreshControl: _react2.default.createElement(_refreshControl2.default, {
          refreshing: this.state.refreshing,
          icon: [_react2.default.createElement('div', { key: '0', className: 'am-refresh-control-pull' }, _react2.default.createElement(_icon2.default, { type: 'arrow-down' }), _react2.default.createElement('span', null, '\u79D1\u6280\u8BA9\u91D1\u878D\u66F4\u7B80\u5355')), _react2.default.createElement('div', { key: '1', className: 'am-refresh-control-release' }, _react2.default.createElement(_icon2.default, { type: 'arrow-up' }), _react2.default.createElement('span', null, '\u79D1\u6280\u8BA9\u91D1\u878D\u66F4\u7B80\u5355'))],
          distanceToRefresh: 40 * window.lib.flexible.dpr,
          onRefresh: this.onRefresh.bind(this) }) }));
    }
  }]);
  return Coupon;
}(_react2.default.Component);

exports.default = Coupon;
module.exports = exports['default'];