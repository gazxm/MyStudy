'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _css = require('antd-mobile/lib/switch/style/css');

var _switch = require('antd-mobile/lib/switch');

var _switch2 = _interopRequireDefault(_switch);

var _css2 = require('antd-mobile/lib/grid/style/css');

var _grid = require('antd-mobile/lib/grid');

var _grid2 = _interopRequireDefault(_grid);

var _css3 = require('antd-mobile/lib/carousel/style/css');

var _carousel = require('antd-mobile/lib/carousel');

var _carousel2 = _interopRequireDefault(_carousel);

var _css4 = require('antd-mobile/lib/modal/style/css');

var _modal = require('antd-mobile/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _css5 = require('antd-mobile/lib/toast/style/css');

var _toast = require('antd-mobile/lib/toast');

var _toast2 = _interopRequireDefault(_toast);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _css6 = require('antd-mobile/lib/list/style/css');

var _list = require('antd-mobile/lib/list');

var _list2 = _interopRequireDefault(_list);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactRouter = require('react-router');

var _rcForm = require('rc-form');

var _reactSlick = require('react-slick');

var _reactSlick2 = _interopRequireDefault(_reactSlick);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

require('scss/integral/signin.component.scss');

require('slick-carousel/slick/slick.css');

var _request = require('common/request');

var _request2 = _interopRequireDefault(_request);

var _utils = require('utils');

var _tweenMax = require('./tween-max');

function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : { default: obj };
}

/* eslint-disable */
var title = '金币签到';
var Item = _list2.default.Item;
var Brief = Item.Brief;

Element.prototype.css = function (key) {
    return document.defaultView.getComputedStyle(this, null)[key];
};

var Integral = function (_Component) {
    (0, _inherits3.default)(Integral, _Component);

    function Integral(props) {
        (0, _classCallCheck3.default)(this, Integral);

        var _this = (0, _possibleConstructorReturn3.default)(this, (Integral.__proto__ || (0, _getPrototypeOf2.default)(Integral)).call(this, props));

        _this.state = {
            lock: 1,
            signin: 0,
            visible: 0,
            guide: {},
            loaded: 0
        };
        return _this;
    }

    (0, _createClass3.default)(Integral, [{
        key: 'componentDidMount',
        value: function componentDidMount() {
            var _this2 = this;

            document.title = title;
            var middleware = this.props.middleware;

            (0, _request2.default)('credit-gold/gold-index').then(function (response) {
                var _response$data = response.data,
                    money = _response$data.score,
                    check_score = _response$data.check_score,
                    is_checked = _response$data.is_checked,
                    days = _response$data.total_check_num,
                    subscribe = _response$data.auto_reminder,
                    modules = _response$data.module;

                _this2.setState({
                    money: money,
                    check_score: check_score,
                    is_checked: is_checked,
                    modules: modules,
                    days: days,
                    subscribe: subscribe,
                    loaded: 1
                });
            }).catch(middleware.bind(this));;
        }
        // 签到订阅

    }, {
        key: 'subscribe',
        value: function subscribe(checked) {
            var _this3 = this;

            var middleware = this.props.middleware;
            var lock = this.state.lock;

            if (lock) {
                _toast2.default.loading(undefined, 0);
                this.setState({ lock: 0 });
                (0, _request2.default)('credit-gold/set-reminder').then(function (response) {
                    var message = response.message,
                        subscribe = response.result.is_auto_reminder;

                    _this3.setState({
                        subscribe: subscribe
                    });
                    _toast2.default.success(message, function () {
                        _this3.setState({ lock: 1 });
                    });
                }).catch(function (response) {
                    var code = response.code,
                        message = response.message;

                    if (code == -1001) {
                        _toast2.default.hide();
                        _modal2.default.alert('提 示', message, [{
                            text: '取消'
                        }, {
                            text: '去登录',
                            onPress: _utils.login
                        }]);
                        _this3.setState({ lock: 1 });
                    } else {
                        middleware.bind(_this3, response)();
                    }
                });
            }
        }
        // 签到

    }, {
        key: 'signin',
        value: function signin() {
            var _this4 = this;

            var _refs = this.refs,
                gold = _refs.gold,
                gold1 = _refs.gold1,
                gold2 = _refs.gold2,
                gold3 = _refs.gold3,
                shadow = _refs.shadow,
                shadow1 = _refs.shadow1,
                shadow2 = _refs.shadow2,
                money1 = _refs.money1,
                money2 = _refs.money2,
                money3 = _refs.money3,
                ribbon1 = _refs.ribbon1,
                ribbon2 = _refs.ribbon2,
                ribbon3 = _refs.ribbon3,
                ribbon4 = _refs.ribbon4,
                ribbon5 = _refs.ribbon5;

            var options = {
                repeatDelay: 1.2,
                repeat: 0,
                yoyo: false
            };
            var timeline = new _tweenMax.TimelineMax(options);
            var middleware = this.props.middleware;
            var _state = this.state,
                lock = _state.lock,
                money = _state.money,
                days = _state.days,
                guide = _state.guide;

            if (lock) {
                _toast2.default.loading(undefined, 0);
                this.setState({ lock: 0 });
                (0, _request2.default)('credit-gold/check?check=1').then(function (response) {
                    var _response$data2 = response.data,
                        check_score = _response$data2.amount,
                        flop = _response$data2.flop,
                        config = _response$data2.diversion_config;

                    _toast2.default.hide();

                    guide.money = check_score;
                    guide.content = config.content;
                    guide.image = config.img;
                    guide.links = config.url;
                    guide.style = guide.image ? { backgroundImage: 'url(' + guide.image + ')' } : {};

                    _this4.setState({
                        check_score: check_score,
                        money: money + check_score,
                        guide: guide
                    });
                    setTimeout(function () {
                        _this4.setState({
                            days: ++days,
                            lock: 1
                        });
                        timeline.to(gold, .15, { x: '-50%', perspective: 1000, width: gold1.css('width'), height: gold1.css('height'), onStart: function onStart() {
                                gold.className += ' disabled';
                            } }, 0).to(gold, .3, { rotationX: -360, y: gold1.css('top'), width: gold.css('width'), height: gold.css('height'), onStart: function onStart() {
                                _this4.setState({ visible: 1 });
                            } }, .15).to(shadow, .1, { width: shadow1.css('width') }, .15).to(gold, .3, { rotationX: -720, y: gold2.css('top'), onStart: function onStart() {
                                gold.className += ' active';
                            } }, .35).to(shadow, .3, { opacity: 1 }, .35).to(shadow, .1, { width: shadow2.css('width') }, .55).to(gold, .1, { y: gold3.css('top'), width: gold2.css('width'), height: gold2.css('height') }, .55)
                        // // elements
                        .to(money1, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(money2, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(money3, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(ribbon1, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(ribbon2, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(ribbon3, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(ribbon4, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(ribbon5, .15, { x: 0, y: 0, scale: 1, opacity: 1 }, .6).to(shadow, .1, { width: shadow.css('width') }, .75).to(gold, .15, { perspective: 0, width: gold.css('width'), height: gold.css('height') }, .75);
                    }, 300);
                    // todo
                    _hmt && _hmt.push(['_trackEvent', '金币签到', 'click', '金币签到']);
                }).catch(middleware.bind(this));
            }
        }
    }, {
        key: 'render',
        value: function render() {
            var _this5 = this;

            var getFieldProps = this.props.form.getFieldProps;
            var _state2 = this.state,
                money = _state2.money,
                check_score = _state2.check_score,
                modules = _state2.modules,
                is_checked = _state2.is_checked,
                days = _state2.days,
                subscribe = _state2.subscribe,
                lock = _state2.lock,
                signin = _state2.signin,
                _state2$guide = _state2.guide,
                guide = _state2$guide === undefined ? {} : _state2$guide,
                visible = _state2.visible,
                loaded = _state2.loaded;

            var notices = function notices(data, index) {
                var items = data.items;

                return _react2.default.createElement(_carousel2.default, {
                    className: 'notices',
                    dots: false,
                    dragging: false,
                    swiping: false,
                    autoplay: true,
                    infinite: true,
                    vertical: true }, items.map(function (item, index) {
                    return _react2.default.createElement('a', { key: index, onClick: function onClick() {
                            return setTimeout(window.location.href = item.link);
                        }, className: 'notice' }, item.text);
                }));
            };
            var guides = function guides(data) {
                var items = data.items;

                return _react2.default.createElement('div', { className: 'guides' }, items.length >= 4 ? _react2.default.createElement(_grid2.default, { data: items, columnNum: items.length, hasLine: false, renderItem: function renderItem(item) {
                        return _react2.default.createElement('div', { className: 'guide', onClick: function onClick() {
                                return setTimeout(window.location.href = item.link);
                            } }, _react2.default.createElement('div', null, _react2.default.createElement('i', { className: 'icon', style: item.img ? { backgroundImage: 'url(' + item.img + ')' } : {} }), item.text));
                    } }) : _react2.default.createElement(_reactSlick2.default, { arrows: false, infinite: false, slidesToShow: 4, slidesToScroll: 4, variableWidth: true }, items && items.length && items.map(function (item, index) {
                    return _react2.default.createElement('div', { key: index, className: 'guide', onClick: function onClick() {
                            return setTimeout(window.location.href = item.link);
                        } }, _react2.default.createElement('div', null, _react2.default.createElement('i', { className: 'icon', style: item.img ? { backgroundImage: 'url(' + item.img + ')' } : {} }), item.text));
                })));
            };
            var gallery = function gallery(data) {
                var items = data.items;

                return _react2.default.createElement(_list2.default, { className: 'gallery', renderHeader: function renderHeader() {
                        return data.name;
                    } }, _react2.default.createElement(_carousel2.default, { infinite: true, dots: items.length > 1, autoplay: items.length > 1, variableWidth: true }, items && items.length && items.map(function (item, index) {
                    return _react2.default.createElement('a', { key: index, href: item.link }, _react2.default.createElement('img', { src: item.img }));
                })));
            };
            var tasks = function tasks(data) {
                var items = data.items;

                return _react2.default.createElement(_list2.default, {
                    className: 'tasks',
                    renderHeader: function renderHeader() {
                        return data.name;
                    },
                    renderFooter: items.length ? function () {
                        return _react2.default.createElement('div', { className: 'more', onClick: function onClick() {
                                return setTimeout(_utils.redirect.push('/integral/tasks'));
                            } }, '\u67E5\u770B\u66F4\u591A');
                    } : false }, items && items.length ? items.map(function (item, index) {
                    return _react2.default.createElement(Item, {
                        key: index,
                        thumb: _react2.default.createElement('i', { style: item.img ? { backgroundImage: 'url(' + item.img + ')' } : {} }),
                        multipleLine: true,
                        extra: '\u4E00\u952E\u9886\u53D6',
                        onClick: function onClick() {
                            return setTimeout(_utils.redirect.push('/integral/tasks'));
                        } }, _react2.default.createElement('div', { className: 'title' }, item.name), _react2.default.createElement(Brief, null, '+', item.gold_score, '\u91D1\u5E01'));
                }) : _react2.default.createElement('div', { className: 'empty' }, '\u6682\u65E0\u6570\u636E'));
            };
            var games = function games(data) {
                var items = data.items;

                return _react2.default.createElement(_list2.default, { className: 'games', renderHeader: function renderHeader() {
                        return _react2.default.createElement('div', { className: 'header', onClick: data.link ? function () {
                                return setTimeout(window.location.href = data.link);
                            } : false }, _react2.default.createElement('span', null, data.name), data.link ? _react2.default.createElement('div', { className: 'more' }, '\u66F4\u591A') : '');
                    } }, _react2.default.createElement(_reactSlick2.default, { arrows: false, infinite: false, slidesToShow: 2, slidesToScroll: 2, variableWidth: true }, items && items.length && items.map(function (item, index) {
                    return _react2.default.createElement('div', {
                        key: index,
                        className: 'game',
                        onClick: function onClick() {
                            return setTimeout(window.location.href = item.link);
                        },
                        style: item.img ? { backgroundImage: 'url(' + item.img + ')' } : {} });
                })));
            };
            return _react2.default.createElement('div', { className: (0, _classnames2.default)({ 'wrapper wrapper-integral-signin': true, loaded: loaded }), style: visible ? {
                    overflow: 'hidden',
                    bottom: 0
                } : {} }, _react2.default.createElement('div', { className: 'main' }, _react2.default.createElement('div', { className: 'topbar' }, _react2.default.createElement('div', null, '\u91D1\u5E01\u6570\u91CF', _react2.default.createElement(_reactRouter.Link, { to: '/signin/detailed' }, money)), _react2.default.createElement('div', { onClick: this.subscribe.bind(this) }, '\u7B7E\u5230\u63D0\u9192', _react2.default.createElement(_switch2.default, {
                checked: subscribe,
                className: (0, _classnames2.default)({ 'am-switch-disabled': !lock }) }))), _react2.default.createElement('div', { className: (0, _classnames2.default)({
                    signin: true,
                    active: is_checked == 2,
                    disabled: is_checked == 1
                }) }, _react2.default.createElement('div', { ref: 'gold1', className: 'gold-frond-stage-1' }), _react2.default.createElement('div', { ref: 'gold2', className: 'gold-frond-stage-2' }), _react2.default.createElement('div', { ref: 'gold3', className: 'gold-frond-stage-3' }), _react2.default.createElement('div', { ref: 'gold', onClick: this.signin.bind(this), className: (0, _classnames2.default)({ 'gold-frond': true }) }, _react2.default.createElement('div', null, '\u70B9\u51FB', _react2.default.createElement('br', null), '\u7B7E\u5230')), _react2.default.createElement('div', { className: 'gold-back' }, _react2.default.createElement('div', null, _react2.default.createElement('span', null, '+', check_score), _react2.default.createElement('br', null), '\u91D1\u5E01'))), _react2.default.createElement('div', { className: 'series' }, '\u5DF2\u7D2F\u8BA1\u7B7E\u5230', days, '\u5929'), _react2.default.createElement('div', { className: 'tips' }, '\u7D2F\u8BA1\u7B7E\u523050\u5929\uFF0C\u53EF\u989D\u5916\u83B7\u5F972000\u91D1\u5E01')), _react2.default.createElement('div', null, modules && modules.map(function (module, index) {
                return _react2.default.createElement('div', { className: 'module', key: index }, module.type == 'gold_checked_page_radio' && module.items && module.items.length && notices(module, index), module.type == 'gold_checked_page_icon' && module.items && module.items.length && guides(module, index), module.type == 'gold_checked_page_banner' && module.items && module.items.length && gallery(module, index), module.type == 'gold_checked_page_task' && tasks(module, index), module.type == 'gold_checked_page_games' && games(module, index));
            })), _react2.default.createElement('div', { className: (0, _classnames2.default)({
                    gold: true,
                    active: visible
                }) }, _react2.default.createElement('div', { ref: 'shadow', className: 'shadow' }), _react2.default.createElement('div', { ref: 'shadow1', className: 'shadow-stage-1' }), _react2.default.createElement('div', { ref: 'shadow2', className: 'shadow-stage-2' }), _react2.default.createElement('div', { ref: 'money1', className: 'money-1' }), _react2.default.createElement('div', { ref: 'money2', className: 'money-2' }), _react2.default.createElement('div', { ref: 'money3', className: 'money-3' }), _react2.default.createElement('div', { ref: 'ribbon1', className: 'ribbon-1' }), _react2.default.createElement('div', { ref: 'ribbon2', className: 'ribbon-2' }), _react2.default.createElement('div', { ref: 'ribbon3', className: 'ribbon-3' }), _react2.default.createElement('div', { ref: 'ribbon4', className: 'ribbon-4' }), _react2.default.createElement('div', { ref: 'ribbon5', className: 'ribbon-5' })), _react2.default.createElement(_modal2.default, { className: 'integral-signin-modal-guide', visible: visible, onClose: function onClose() {
                    return _this5.setState({ visible: 0, is_checked: 2 });
                }, maskClosable: false, transparent: true }, _react2.default.createElement('div', { className: 'title' }, _react2.default.createElement('p', null, '\u606D\u559C\u4F60\uFF01\u83B7\u5F97', guide.money, '\u91D1\u5E01'), '\u53C2\u52A0\u6D3B\u52A8\u83B7\u5F97\u66F4\u591A\u91D1\u5E01'), _react2.default.createElement('div', { className: 'picture', style: guide.style }), _react2.default.createElement('div', { className: 'description', dangerouslySetInnerHTML: { __html: guide.content } }), _react2.default.createElement('a', { className: 'link', href: '' + (guide.links ? guide.links : 'javascript:;') }, '\u70B9\u51FB\u67E5\u770B')));
        }
    }]);
    return Integral;
}(_react.Component);

;
exports.default = (0, _rcForm.createForm)()(Integral);
module.exports = exports['default'];