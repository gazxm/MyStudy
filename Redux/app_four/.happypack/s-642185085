'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _css = require('antd-mobile/lib/button/style/css');

var _button = require('antd-mobile/lib/button');

var _button2 = _interopRequireDefault(_button);

var _css2 = require('antd-mobile/lib/icon/style/css');

var _icon = require('antd-mobile/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _css3 = require('antd-mobile/lib/popup/style/css');

var _popup = require('antd-mobile/lib/popup');

var _popup2 = _interopRequireDefault(_popup);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _css4 = require('antd-mobile/lib/checkbox/style/css');

var _checkbox = require('antd-mobile/lib/checkbox');

var _checkbox2 = _interopRequireDefault(_checkbox);

var _css5 = require('antd-mobile/lib/list/style/css');

var _list = require('antd-mobile/lib/list');

var _list2 = _interopRequireDefault(_list);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _utils = require('utils');

require('scss/mobile/loan.component.scss');

var _Toast = require('components/Toast');

var _Toast2 = _interopRequireDefault(_Toast);

var _Password = require('components/Password');

var _Password2 = _interopRequireDefault(_Password);

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var Item = _list2.default.Item;
var AgreeItem = _checkbox2.default.AgreeItem;
// const alert = Modal.alert
// const CheckboxItem = Checkbox.CheckboxItem


var isIPhone = new RegExp('\\biPhone\\b|\\biPod\\b', 'i').test(window.navigator.userAgent);
var maskProps = void 0;
if (isIPhone) {
  // Note: the popup content will not scroll.
  maskProps = {
    onTouchStart: function onTouchStart(e) {
      return e.preventDefault();
    }
  };
}

var Loan = function (_React$Component) {
  (0, _inherits3.default)(Loan, _React$Component);

  function Loan(props) {
    (0, _classCallCheck3.default)(this, Loan);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Loan.__proto__ || (0, _getPrototypeOf2.default)(Loan)).call(this, props));

    _this.onChange = function (i) {
      _popup2.default.hide();
      _this.setState({ couponIndex: i });
      var params = _this.props.params;

      params.coupon_id = _this.state.coupon_list[i].coupon_id;
      // console.log(params)
      _utils.redirect.replace('/mobile/loan/' + params.card_type + '/' + params.period + '/' + params.money + '/' + params.coupon_id);
      _this.fetchData(params);
    };

    _this.state = {
      money: '',
      period: '',
      true_money: '',
      counter_fee: '',
      bank_name: '',
      card_no: '',
      coupon_total: '',
      coupon_list: [],
      real_pay_pwd_status: '',
      tips: '',
      couponIndex: -1,
      agree: true
    };
    return _this;
  }

  (0, _createClass3.default)(Loan, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      this.fetchData(this.props.params);
      // console.log(this.props)
    }
  }, {
    key: 'fetchData',
    value: function fetchData(params) {
      var _this2 = this;

      _Toast2.default.loading('加载中...');
      (0, _utils.post)('http://credit.xianjincard.com/credit-loan/get-confirm-loan', params).then(function (result) {
        _Toast2.default.hide();
        // 不能再借
        if (result.data.code === -1) {
          _Toast2.default.info(result.data.message, 2, function () {
            _utils.redirect.goBack();
          });
          return;
        }
        if (result.data.code !== 0) {
          _Toast2.default.info(result.data.message, 2);
          return;
        }
        // 默认优惠券数组第一个是选中
        if (_this2.state.couponIndex !== -1) {
          result.data.data.item.couponIndex = 0;
        }
        _this2.setState((0, _extends3.default)({}, result.data.data.item));
        // console.log(result)
      }).catch(function (error) {
        return error;
      });
    }
  }, {
    key: 'item',
    value: function item(couponList) {
      var _this3 = this;

      return couponList.map(function (rowData, i) {
        var title = parseInt(rowData.use_case) === 4 ? _react2.default.createElement('h3', null, rowData.title) : _react2.default.createElement('h4', null, _react2.default.createElement('i', null, '\uFFE5'), rowData.amount);
        return _react2.default.createElement('div', { key: i, className: 'coupon-item', onClick: _this3.onChange.bind(_this3, i) }, _react2.default.createElement('span', null, title), _react2.default.createElement('span', { className: 'active' }, _react2.default.createElement('div', null, _react2.default.createElement('h3', null, rowData.coupon_name), _react2.default.createElement('p', null, rowData.loan_amount), _react2.default.createElement('p', null, rowData.loan_term), _react2.default.createElement('p', null, rowData.time), _react2.default.createElement('b', { className: i === _this3.state.couponIndex && 'active' }))));
      });
    }
  }, {
    key: 'onSelected',
    value: function onSelected() {
      var coupon_list = this.state.coupon_list;

      if (coupon_list.length <= 0) return;

      _popup2.default.show(_react2.default.createElement('div', { className: 'loan-popup' }, _react2.default.createElement('h1', null, '\u53EF\u7528\u4F18\u60E0\u5238', _react2.default.createElement(_icon2.default, { type: 'cross', onClick: function onClick() {
          _popup2.default.hide();
        } })), _react2.default.createElement('div', { className: 'content' }, _react2.default.createElement('div', { className: 'warp' }, this.item(coupon_list)), _react2.default.createElement('div', { className: 'button' }, _react2.default.createElement(_button2.default, { className: 'btn', onClick: this.onCancel.bind(this) }, '\u4E0D\u4F7F\u7528\u4F18\u60E0\u5238')))), { animationType: 'slide-up', maskProps: maskProps, maskClosable: false });
    }
  }, {
    key: 'onCancel',
    value: function onCancel() {
      _popup2.default.hide();
      this.setState({ couponIndex: -1 });
      var params = this.props.params;

      console.log(params);
      _utils.redirect.push('/mobile/loan/' + params.card_type + '/' + params.period + '/' + params.money);
    }
  }, {
    key: 'onAgree',
    value: function onAgree(e) {
      this.setState({ agree: !this.state.agree });
    }
  }, {
    key: 'onSubmit',
    value: function onSubmit() {
      var hasPay = this.state.real_pay_pwd_status;
      //    console.log(real_pay_pwd_status)

      hasPay === 1 ? this.onConfirm() : this.onPassword();
    }
  }, {
    key: 'onConfirm',
    value: function onConfirm() {
      var _this4 = this;

      _Password2.default.show(function (value) {
        _this4.confirm(value);
      }, '请输入交易密码');
    }
  }, {
    key: 'confirm',
    value: function confirm(password) {
      var params = this.props.params;

      params.pay_password = password;
      _Toast2.default.loading('加载中...');
      (0, _utils.post)('http://credit.xianjincard.com/credit-loan/apply-loan', params).then(function (result) {
        _Toast2.default.hide();
        // console.log(result)
        var data = result.data;
        if (data.code === 3) {
          _Password2.default.error();
          return;
        }
        if (data.code === 0) {
          // 借款成功
          _Password2.default.remove();
          (0, _utils.sendEventSDK)(data.item.tick);
          _utils.redirect.push('/mobile/loan');
          return;
        }
        _Toast2.default.info(data.message, 2);
      });
    }
  }, {
    key: 'onPassword',
    value: function onPassword() {
      var _this5 = this;

      _Password2.default.show(function (value) {
        _Password2.default.show(function (password) {
          _this5.setPassword(value, password);
        }, '请确认交易密码');
      }, '请设置交易密码');
    }
  }, {
    key: 'setPassword',
    value: function setPassword(old, password) {
      var _this6 = this;

      console.log(old, password);
      if (old !== password) {
        _Password2.default.error('两次输入交易密码不同');
        return;
      }
      _Toast2.default.loading('加载中...');
      (0, _utils.post)('http://credit.xianjincard.com/credit-user/set-paypassword', { 'password': password }).then(function (result) {
        //  console.log(result)
        _Toast2.default.hide();
        if (result.data.code === 0) {
          _Toast2.default.info(result.data.message, 1, function () {
            _this6.onConfirm();
          });
          return;
        }
        _Toast2.default.info(result.data.message, 2);
      });
    }
  }, {
    key: 'render',
    value: function render() {
      var _this7 = this;

      var data = this.state;
      var amountStr = '不使用券';
      if (data.coupon_list.length > 0) {
        if (data.couponIndex >= 0) {
          amountStr = data.coupon_list[data.couponIndex]['str_amount'];
        } else if (this.props.params.coupon_id !== undefined) {
          data.coupon_list.map(function (v, i) {
            if (parseInt(v.coupon_id) === parseInt(_this7.props.params.coupon_id)) {
              data.couponIndex = i;
              amountStr = v.str_amount;
              return;
            }
          });
        }
      } else {
        amountStr = '';
      }
      // <a href="">《平台服务协议》</a><br/><a href="">《授权扣款委托书》</a>
      return _react2.default.createElement('div', { className: 'loan-confirm' }, _react2.default.createElement(_list2.default, { className: 'loan-list' }, _react2.default.createElement(Item, { extra: data.money + '(元)' }, '\u501F\u6B3E\u91D1\u989D'), _react2.default.createElement(Item, { extra: data.period + '(天)' }, '\u501F\u6B3E\u671F\u9650'), _react2.default.createElement(Item, { extra: data.true_money + '(元)' }, '\u5B9E\u9645\u5230\u5E10'), _react2.default.createElement(Item, { extra: data.counter_fee + '(元)' }, '\u670D\u52A1\u8D39\u7528'), _react2.default.createElement(Item, { extra: data.bank_name }, '\u5230\u5E10\u94F6\u884C'), _react2.default.createElement(Item, { extra: data.card_no }, '\u53D6\u73B0\u5361\u53F7')), _react2.default.createElement(_list2.default, { className: 'select-item' }, _react2.default.createElement(Item, { className: data.couponIndex >= 0 && 'active ', extra: amountStr, arrow: !amountStr || 'horizontal', onClick: this.onSelected.bind(this) }, '\u53EF\u7528\u5238', _react2.default.createElement('i', null, data.coupon_total, '\u5F20\u53EF\u7528\u5238'))), _react2.default.createElement('p', { className: 'info', dangerouslySetInnerHTML: { __html: data.tips.replace(/(\d+\.?\d+)/g, '<b>$1</b>') } }), _react2.default.createElement('div', { className: 'button' }, _react2.default.createElement(_button2.default, { disabled: !data.agree, type: 'primary', onClick: this.onSubmit.bind(this) }, '\u786E\u8BA4\u7533\u8BF7')), _react2.default.createElement(AgreeItem, { 'data-seed': 'logId', defaultChecked: data.agree, onChange: this.onAgree.bind(this) }, '\u6211\u5DF2\u9605\u8BFB\u5E76\u540C\u610F', _react2.default.createElement('a', { href: data.protocol_url }, '\u300A\u501F\u6B3E\u534F\u8BAE\u300B')), _react2.default.createElement('div', { className: 'bg-logo' }));
    }
  }]);
  return Loan;
}(_react2.default.Component);

exports.default = Loan;
module.exports = exports['default'];