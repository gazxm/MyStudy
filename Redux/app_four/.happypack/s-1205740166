'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = undefined;

var _css = require('antd-mobile/lib/modal/style/css');

var _modal = require('antd-mobile/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _css2 = require('antd-mobile/lib/toast/style/css');

var _toast = require('antd-mobile/lib/toast');

var _toast2 = _interopRequireDefault(_toast);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _css3 = require('antd-mobile/lib/list/style/css');

var _list = require('antd-mobile/lib/list');

var _list2 = _interopRequireDefault(_list);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _utils = require('utils');

var _request = require('./request');

var _request2 = _interopRequireDefault(_request);

require('scss/integral-mall/index.component.scss');

function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : { default: obj };
}

/* eslint-disable */
var title = '金币商城';
var Item = _list2.default.Item;
var Brief = Item.Brief;
var lock = true;

var Details = function (_Component) {
    (0, _inherits3.default)(Details, _Component);

    function Details(props) {
        (0, _classCallCheck3.default)(this, Details);

        var _this = (0, _possibleConstructorReturn3.default)(this, (Details.__proto__ || (0, _getPrototypeOf2.default)(Details)).call(this, props));

        _this.state = {
            name: '',
            image: '',
            price: 0,
            loaded: 0,
            description: []
        };
        return _this;
    }

    (0, _createClass3.default)(Details, [{
        key: 'componentDidMount',
        value: function componentDidMount() {
            var _this2 = this;

            document.title = title;
            var params = this.props.location.query;

            (0, _request2.default)('credit-gold/goods-detail?id=' + params.id).then(function (response) {
                var _response$data = response.data,
                    id = _response$data.id,
                    name = _response$data.name,
                    price = _response$data.price,
                    disc_price = _response$data.disc_price,
                    image = _response$data.default_img,
                    desc_img = _response$data.desc_img,
                    description = _response$data.description,
                    status = _response$data.status;

                _this2.setState({
                    id: id,
                    name: name,
                    image: image,
                    desc_img: desc_img,
                    price: price,
                    disc_price: disc_price,
                    loaded: 1,
                    description: description,
                    status: status
                });
            }).catch(this.middleware.bind(this));
        }
    }, {
        key: 'middleware',
        value: function middleware(response) {
            var code = response.code,
                message = response.message;

            var type = 'info';

            _toast2.default.hide();
            if ([-1000, -1004].indexOf(code) >= 0) {
                type = 'fail';
            } else if ([-1003].indexOf(code) >= 0) {
                type = 'offline';
            } else if (-1001 === code) {
                (0, _utils.login)();
                return;
            }
            this.setState({
                loaded: 1
            });
            _toast2.default[type](message);
        }
    }, {
        key: 'submit',
        value: function submit() {
            var _this3 = this;

            _modal2.default.alert(undefined, '确认兑换？', [{
                text: '取消'
            }, {
                text: '兑换',
                onPress: function onPress() {
                    var _state = _this3.state,
                        id = _state.id,
                        status = _state.status;

                    if (lock && status) {
                        lock = !lock;
                        var params = new FormData();
                        params.append('id', id);
                        _toast2.default.loading(undefined, 0);
                        (0, _request2.default)({
                            url: 'credit-gold/exchange',
                            data: params,
                            method: 'post'
                        }).then(function (response) {
                            _toast2.default.success('兑换成功', function () {
                                lock = !lock;
                            });
                        }).catch(function (response) {
                            var code = response.code,
                                message = response.message;

                            if (code == -2102) {
                                _toast2.default.fail(message, function () {
                                    return _utils.redirect.push('/signin');
                                });
                            } else {
                                _this3.middleware.bind(_this3, response)();
                            }
                        });
                    }
                }
            }]);
        }
    }, {
        key: 'middleware',
        value: function middleware(response) {
            var code = response.code,
                message = response.message;

            var type = 'info';
            if ([-1015, -1016].indexOf(code) >= 0) {
                type = 'offline';
            } else if (-1001 === code) {
                (0, _utils.login)();
                return;
            } else {
                type = 'fail';
            }
            _toast2.default[type](message, 1.5);
            setTimeout(function () {
                lock = true;
            }, 1500);
        }
    }, {
        key: 'render',
        value: function render() {
            var _state2 = this.state,
                name = _state2.name,
                image = _state2.image,
                desc_img = _state2.desc_img,
                price = _state2.price,
                disc_price = _state2.disc_price,
                loaded = _state2.loaded,
                description = _state2.description,
                status = _state2.status;

            var content = function content(data, index) {
                return _react2.default.createElement('li', { key: index }, _react2.default.createElement('h5', null, data.title), _react2.default.createElement('div', { className: 'details', dangerouslySetInnerHTML: { __html: data.desc } }));
            };
            var priceElement = function priceElement(origin, sale) {
                return _react2.default.createElement('div', { className: 'price' }, !!sale && sale < price && _react2.default.createElement('p', { className: 'sale' }, _react2.default.createElement('span', null, price)), _react2.default.createElement('p', { className: 'origin' }, _react2.default.createElement('span', null, !!sale && sale < price ? sale : price)));
            };
            return _react2.default.createElement('div', { className: 'wrapper wrapper-integral-mall-old toolbar-through ' + (loaded ? 'loaded' : '') }, _react2.default.createElement('div', { className: 'carousel' }, _react2.default.createElement('a', { className: 'slider-link', href: 'javascript:;' }, _react2.default.createElement('img', { src: desc_img }))), _react2.default.createElement(_list2.default, { className: 'main' }, _react2.default.createElement(Item, {
                multipleLine: true,
                extra: priceElement(price, disc_price) }, name, _react2.default.createElement(Brief, null, _react2.default.createElement('span', { className: '' + (status ? '' : 'disabled') }, status ? '抢购中' : '已抢完')))), description.length && _react2.default.createElement('ul', { className: 'description' }, description.map(function (desc, index) {
                return content(desc, index);
            })), _react2.default.createElement('div', { className: 'toolbar' }, _react2.default.createElement('div', { className: 'button ' + (status ? '' : 'disabled'), onClick: this.submit.bind(this) }, status ? '马上兑换' : '抢光啦')));
        }
    }]);
    return Details;
}(_react.Component);

exports.default = Details;
;
module.exports = exports['default'];