'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _Content = require('./Content');

var _Content2 = _interopRequireDefault(_Content);

var _Lottery = require('../components/Lottery');

var _Lottery2 = _interopRequireDefault(_Lottery);

var _Popup = require('../components/Popup');

var _Popup2 = _interopRequireDefault(_Popup);

var _Toast = require('../../../components/Toast');

var _Toast2 = _interopRequireDefault(_Toast);

var _utils = require('utils');

require('scss/activity/scratch.component.scss');

require('img/activity/scratch-card/scratch-04.jpg');

require('img/activity/scratch-card/scratch-10.jpg');

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var totalLength = 7;
var rewardFlag = 1;
var toastFlag = 1;
var width = 0;
var height = 0;

var Scratch = function (_React$Component) {
  (0, _inherits3.default)(Scratch, _React$Component);

  function Scratch(props) {
    (0, _classCallCheck3.default)(this, Scratch);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Scratch.__proto__ || (0, _getPrototypeOf2.default)(Scratch)).call(this, props));

    _this.state = {
      total: [0, 0, 0, 0, 0, 0, 0],
      prizeList: [],
      times: 0,
      exchangeGold: 0
    };
    return _this;
  }

  (0, _createClass3.default)(Scratch, [{
    key: 'componentWillMount',
    value: function componentWillMount() {
      var _this2 = this;

      if (!_utils.platform.isApp) {
        document.body.className = 'copy';
      }
      _Toast2.default.loading('');
      (0, _utils.get)('http://credit.xianjincard.com/activity/scratch-act/index').then(function (data) {
        return data.data;
      }).then(function (data) {
        _Toast2.default.hide();
        if (data.code !== 0) {
          _Popup2.default.alert(_Content2.default.showHtml(data.code), 'popup-show');
          if (data.code === -1001) {
            _Popup2.default.click('a.click', _utils.login);
            return;
          }
          _Popup2.default.click('a.click');
          return;
        }
        _this2.setState({
          total: _this2.formatTotal(data.data.person),
          prizeList: data.data.prize_list,
          times: data.data.times,
          exchangeGold: data.data.exchange_gold
        });
      });
    }
  }, {
    key: 'componentDidMount',
    value: function componentDidMount() {
      document.title = '惊喜刮刮乐';
      (0, _utils.share)('scratch');
      width = document.getElementsByClassName('canvas')[0].offsetWidth;
      height = document.getElementsByClassName('canvas')[0].offsetHeight;
      this.init();
    }
  }, {
    key: 'init',
    value: function init() {
      _Lottery2.default.init(this.refs.lotteryContainer, '../assets/img/activity/scratch-card/scratch-04.jpg', 'image', width, height, 50, 60, '../assets/img/activity/scratch-card/scratch-10.jpg', 'image', this.scratch.bind(this));
    }
  }, {
    key: 'scratch',
    value: function scratch(per) {
      var _this3 = this;

      if (per > 35 && rewardFlag) {
        rewardFlag = 0;
        _Toast2.default.loading('');
        (0, _utils.get)('http://credit.xianjincard.com/activity/scratch-act/scratch').then(function (data) {
          return data.data;
        }).then(function (data) {
          _Toast2.default.hide();
          _Popup2.default.alert(_Content2.default.rewardHtml(data.data, _utils.platform.isApp), 'popup-reward');
          _Popup2.default.addEventListener('a.copy', 'click', function () {
            (0, _utils.copy)(data.data.prize_sn);
          });
          _this3.setState({
            times: --_this3.state.times
          });
        });
      }
      if (per < 35 && toastFlag) {
        toastFlag = 0;
        _Toast2.default.info('请在多刮一点哦', 2);
        setTimeout(function () {
          toastFlag = 1;
        }, 2200);
      }
    }
  }, {
    key: 'formatTotal',
    value: function formatTotal(total) {
      var array = [];
      var num = total + '';
      var length = num.length;
      if (length < totalLength) {
        for (var i = 0; i < totalLength - length; i++) {
          num = '0' + num;
        }
      }
      for (var _i = 0; _i < num.length; _i++) {
        array = [].concat((0, _toConsumableArray3.default)(array), (0, _toConsumableArray3.default)(num[_i]));
      }
      return array;
    }
  }, {
    key: 'showRule',
    value: function showRule() {
      var exchangeGold = this.state.exchangeGold;

      _Popup2.default.alert(_Content2.default.ruleHtml(exchangeGold), 'popup-rule');
    }
  }, {
    key: 'reward',
    value: function reward() {
      var prizeList = this.state.prizeList;

      _Popup2.default.alert(_Content2.default.myReward(prizeList, _utils.platform.isApp), 'popup-my');
      prizeList.map(function (v, i) {
        _Popup2.default.addEventListener('a.copy-' + i, 'click', function () {
          (0, _utils.copy)(v.prize_sn);
        });
      });
    }
  }, {
    key: 'exchange',
    value: function exchange() {
      var _this4 = this;

      _Toast2.default.loading('');
      (0, _utils.get)('http://credit.xianjincard.com/activity/scratch-act/exchange').then(function (data) {
        return data.data;
      }).then(function (data) {
        _Toast2.default.hide();
        _Popup2.default.alert(_Content2.default.showHtml(data.code), 'popup-show');
        if (data.code !== 0) {
          if (data.code === -1001) {
            _Popup2.default.click('a.click', _utils.login);
            return;
          }
          if (data.code === -2031) {
            _Popup2.default.click('a.click', function () {
              _utils.redirect.push('/signin');
            });
            return;
          }
        }
        _Popup2.default.click('a.click');
        _this4.setState({
          times: ++_this4.state.times
        });
      });
    }
  }, {
    key: 'overlay',
    value: function overlay() {
      _Popup2.default.alert(_Content2.default.showHtml(-2100), 'popup-show');
      _Popup2.default.click('a.click', _utils.goHome);
    }
  }, {
    key: 'refresh',
    value: function refresh() {
      this.init();
      rewardFlag = 1;
    }
  }, {
    key: 'render',
    value: function render() {
      var _state = this.state,
          total = _state.total,
          times = _state.times;

      var li = total.map(function (v, i) {
        return _react2.default.createElement('li', { key: i }, v);
      });
      var overlay = times < 0 ? _react2.default.createElement('div', { className: 'overlay', onClick: this.overlay.bind(this) }) : null;

      return _react2.default.createElement('div', { className: 'transition-group' }, _react2.default.createElement('div', { className: 'scratch' }, _react2.default.createElement('a', { className: 'rule', onClick: this.showRule.bind(this) }, '\u6D3B\u52A8\u9526\u56CA'), _react2.default.createElement('div', { className: 'content' }, _react2.default.createElement('div', { className: 'join-total clearfix' }, _react2.default.createElement('span', null, '\u53C2\u52A0', _react2.default.createElement('br', null), '\u4EBA\u6570'), _react2.default.createElement('ul', null, li)), _react2.default.createElement('h3', null, '\u60A8\u4ECA\u5929\u8FD8\u6709', _react2.default.createElement('b', null, times), '\u6B21\u62BD\u5956\u673A\u4F1A'), _react2.default.createElement('div', { className: 'canvas-content' }, overlay, _react2.default.createElement('i', { onClick: this.refresh.bind(this) }), _react2.default.createElement('div', { ref: 'lotteryContainer', className: 'canvas' })), _react2.default.createElement('a', { className: 'exchange', onClick: this.exchange.bind(this) }, '\u91D1\u5E01\u5151\u6362\u62BD\u5956\u673A\u4F1A'), _react2.default.createElement('a', { className: 'reward', onClick: this.reward.bind(this) }, '\u6211\u7684\u5956\u54C1'))));
    }
  }]);
  return Scratch;
}(_react2.default.Component);

exports.default = Scratch;
module.exports = exports['default'];